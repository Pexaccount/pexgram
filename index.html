<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="google-site-verification" content="i7sO3m2l0_fpbA_-4BczKk_ITe6mvcpJ-KLBvJHLOS0" />
  <title>Pexgram</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --accent: linear-gradient(135deg, #7b61ff 0%, #39d7ff 100%);
      --text: rgba(255, 255, 255, 0.95);
      --muted: rgba(255, 255, 255, 0.65);
      --danger: #ff5656;
    }

    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: radial-gradient(ellipse at 10% 10%, #0f1724 0%, #071028 40%, #0b1220 100%);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      min-height: 100vh;
    }

    /* === ç™»å½•/æ³¨å†Œé¢æ¿ === */
    #authPanel {
      width: 100%;
      max-width: 760px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 18px;
      padding: 60px 48px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 30px rgba(2, 6, 23, 0.6);
      display: flex;
      flex-direction: column;
      align-items: stretch;
      overflow: visible;
      min-height: auto;
      margin-top: 28px;
      margin-bottom: 28px;
    }

    .auth-title { font-size: 32px; font-weight: 800; margin: 0 0 24px 0; text-align: center; flex-shrink: 0; }
    .auth-form { display: flex; flex-direction: column; gap: 18px; overflow: visible; padding-right: 0; width:100%; }
    .emoji-picker-container { display: none; position: absolute; bottom: 60px; left: 16px; background: rgba(255, 255, 255, 0.08);
      border-radius: 12px; padding: 8px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1000; }
    .emoji-picker-container.show { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; }
    .emoji-item { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 24px; border-radius: 8px; transition: all 0.2s; }
    .emoji-item:hover { background: rgba(255, 255, 255, 0.1); transform: scale(1.2); }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group label { font-size: 13px; color: var(--muted); font-weight: 500; }
    .form-group input {
      padding: 16px 18px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(255, 255, 255, 0.02);
      color: var(--text);
      outline: none;
      font-size: 15px;
      transition: border-color 0.2s;
    }
    /* ä¿®æ­£ï¼šç™»å½•é¢æ¿å†…è¾“å…¥ä¸è¶…å‡ºå®¹å™¨ */
    #authPanel .form-group input, #authPanel input {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    .form-group input:focus { border-color: rgba(59, 130, 246, 0.5); }

    .auth-btn {
      padding: 16px 20px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.1s;
      flex-shrink: 0;
      margin-top: 14px;
      font-size: 16px;
    }
    .auth-btn:active { transform: scale(0.98); }

    /* ç»Ÿä¸€æŒ‰é’®æ ·å¼ï¼ˆä¸åŒ…å«æ³¨é”€æŒ‰é’®ï¼‰ */
    .unified-btn { background: linear-gradient(135deg,#2563eb 0%,#39d7ff 100%); color:#fff; border:none; border-radius:8px; padding:6px 10px; cursor:pointer; font-weight:600; }
    .unified-btn:active { transform: scale(0.98); }

    .auth-tabs { display: flex; gap: 12px; margin-bottom: 20px; }
    .auth-tab { flex: 1; padding: 12px; border: none; border-radius: 10px; cursor: pointer;
      background: rgba(255, 255, 255, 0.02); color: var(--muted); transition: all 0.2s; font-weight: 500; }
    .auth-tab.active { background: var(--accent); color: #fff; }

    .auth-msg { font-size: 12px; color: var(--danger); margin-top: 8px; text-align: center; }

    /* === èŠå¤©ç•Œé¢ === */
    #chatPanel {
      width: 100%;
      max-width: 1200px;
      height: 90vh;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 30px rgba(2, 6, 23, 0.6);
      display: none;
      overflow: hidden;
      position: relative;
    }

    #chatPanel.active {
      display: flex;
    }

    #authPanel.hidden {
      display: none;
    }

    /* å·¦ä¾§ï¼šå¥½å‹å’Œç”¨æˆ·é¢æ¿ */
    .left-sidebar {
      width: 280px;
      border-right: 1px solid rgba(255, 255, 255, 0.04);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.01);
    }

    .user-profile {
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, #7b61ff 0%, #39d7ff 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      position: relative;
      overflow: hidden;
    }

    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-upload { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

    .user-info { flex: 1; min-width: 0; }
    .user-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-status { font-size: 11px; color: var(--muted); }

    .user-actions { display: flex; gap: 6px; }
    .icon-btn-small { width: 32px; height: 32px; border-radius: 50%; border: none; background: rgba(255, 255, 255, 0.05);
      color: var(--text); cursor: pointer; font-size: 14px; transition: background 0.2s; }
    .icon-btn-small:hover { background: rgba(255, 255, 255, 0.1); }

    .sidebar-section-title { font-size: 11px; color: var(--muted); text-transform: uppercase; padding: 12px 12px 6px 12px;
      font-weight: 600; margin-top: 6px; }

    #friendsList { flex: 1; overflow-y: auto; padding: 6px 0; }
    .friend-item { padding: 10px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px;
      border-left: 3px solid transparent; transition: all 0.2s; }
    .friend-item:hover { background: rgba(255, 255, 255, 0.05); }
    .friend-item.active { background: rgba(59, 130, 246, 0.1); border-left-color: #39d7ff; }
    .friend-item .avatar-sm { width: 32px; height: 32px; border-radius: 50%; background: #7b61ff; flex-shrink: 0; }
    .friend-item .avatar-sm { display: flex; align-items: center; justify-content: center; overflow: hidden; color: #fff; }
    .friend-info { min-width: 0; }
    .friend-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .friend-info { flex: 1; min-width: 0; }
    .friend-name { font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .add-friend-btn { width: calc(100% - 24px); margin: 12px; border: none; border-radius: 8px; padding: 10px;
      background: rgba(59, 130, 246, 0.15); color: #39d7ff; cursor: pointer; font-size: 12px; transition: all 0.2s; }
    .add-friend-btn:hover { background: rgba(59, 130, 246, 0.25); }

    /* å³ä¾§ï¼šèŠå¤©åŒº */
    .chat-main { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }

    .chat-header { padding: 12px 16px; border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      display: flex; align-items: center; justify-content: space-between; position: relative; }
    .chat-header h3 { margin: 0; font-size: 14px; }
    .chat-header-info { font-size: 11px; color: var(--muted); }
    .contact-btn { width: 36px; height: 36px; border-radius: 50%; border: none; background: rgba(255, 255, 255, 0.05);
      color: var(--text); cursor: pointer; font-size: 16px; transition: all 0.2s; }
    .contact-btn:hover { background: rgba(255, 255, 255, 0.1); }
    .contact-menu { display: none; position: absolute; top: 50px; right: 16px; background: rgba(255, 255, 255, 0.08);
      border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); min-width: 220px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3); z-index: 1000; }
    .contact-menu.show { display: block; }
    .contact-item { padding: 12px 16px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); cursor: pointer;
      transition: all 0.2s; font-size: 12px; }
    .contact-item:last-child { border-bottom: none; }
    .contact-item:hover { background: rgba(255, 255, 255, 0.05); }
    .contact-label { color: var(--muted); font-size: 11px; margin-right: 8px; }
    .contact-text { color: var(--text); word-break: break-all; }

    #messagesArea { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }

    .msg { display: flex; flex-direction: column; align-items: flex-start; gap: 4px; animation: slideIn 0.3s ease; }
    .msg.me { align-items: flex-end; }

    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .msg-meta { font-size: 11px; color: var(--muted); }
    .msg-bubble { max-width: 70%; padding: 10px 14px; border-radius: 12px;
      background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.04); word-break: break-word; }
    .msg.me .msg-bubble { background: rgba(59, 130, 246, 0.18); border-color: rgba(59, 130, 246, 0.25); }

    .msg-bubble img { max-width: 100%; border-radius: 8px; margin-bottom: 6px; cursor: pointer; transition: transform 0.2s; }
    .msg-bubble img:hover { transform: scale(1.05); }
    .image-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9);
      z-index: 2000; align-items: center; justify-content: center; }
    .image-modal.show { display: flex; }
    .image-modal img { max-width: 90%; max-height: 90%; border-radius: 8px; }
    .msg-bubble audio { width: 100%; max-width: 300px; margin-top: 6px; }
    .msg-bubble a { color: #39d7ff; text-decoration: none; }

    /* è¾“å…¥åŒº */
    .input-area {
      padding: 12px 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.04);
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: rgba(255, 255, 255, 0.01);
    }

    .input-toolbar { display: flex; gap: 8px; align-items: center; }
    .icon-btn { width: 36px; height: 36px; border-radius: 50%; border: none;
      background: rgba(255, 255, 255, 0.05); color: var(--text); cursor: pointer; font-size: 16px;
      transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
    .icon-btn:hover { background: rgba(255, 255, 255, 0.1); }
    .icon-btn.recording { background: var(--danger); box-shadow: 0 0 12px rgba(255, 86, 86, 0.3); }

    #inputBox { display: flex; gap: 8px; align-items: flex-end; }
    .input-wrapper { flex: 1; display: flex; flex-direction: column; gap: 4px; }
    textarea#msgInput { width: 100%; min-height: 36px; max-height: 120px; resize: none;
      padding: 8px 12px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(255, 255, 255, 0.02); color: var(--text); outline: none; font-family: inherit;
      font-size: 13px; transition: all 0.2s; line-height: 1.4; }
    textarea#msgInput:focus { border-color: rgba(59, 130, 246, 0.5); box-shadow: 0 0 8px rgba(59, 130, 246, 0.1); }

    #sendBtn { padding: 8px 16px; border-radius: 999px; border: none; background: var(--accent);
      color: #fff; cursor: pointer; font-weight: 600; transition: all 0.1s; font-size: 13px; white-space: nowrap; }
    #sendBtn:active { transform: scale(0.95); }

    .hidden-input { display: none; }

    /* å“åº”å¼ */
    @media (max-width: 900px) {
      .left-sidebar { width: 220px; }
      #messagesArea { padding: 12px; }
      .msg-bubble { max-width: 80%; }
    }

    @media (max-width: 768px) {
      body { padding: 6px; }
      #authPanel { padding: 30px 20px; max-width: 100%; overflow: visible; }
      #chatPanel { max-width: 100%; height: 100vh; }
      .left-sidebar { width: 200px; }
    }

    /* === æ‰‹æœºç‰ˆï¼ˆ640pxä»¥ä¸‹ï¼‰ === */
    @media (max-width: 640px) {
      body { 
        padding: 0; 
        align-items: stretch;
        justify-content: flex-start;
      }

      /* è®¤è¯é¢æ¿ - å…¨å± */
      #authPanel { 
        width: 100%;
        max-width: none;
        height: 100vh;
        padding: 20px 16px;
        margin: 0;
        border-radius: 0;
        border: none;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }

      .auth-title { 
        font-size: 24px; 
        margin: 20px 0 20px 0;
      }

      .auth-form { 
        gap: 12px;
      }

      .form-group input {
        padding: 12px 14px;
        font-size: 14px;
      }

      .auth-btn {
        padding: 12px 14px;
        font-size: 14px;
        margin-top: 8px;
      }

      .auth-tabs {
        gap: 8px;
        margin-bottom: 16px;
      }

      .auth-tab {
        padding: 10px 8px;
        font-size: 12px;
      }

      /* èŠå¤©é¢æ¿ - æ”¹ä¸ºç«–å±å¸ƒå±€ */
      #chatPanel { 
        width: 100%;
        max-width: none;
        height: 100vh;
        border-radius: 0;
        border: none;
        flex-direction: column;
        overflow: hidden;
      }

      /* å¥½å‹åˆ—è¡¨å˜æˆæŠ½å±‰å¼ */
      .left-sidebar { 
        display: none;
        position: fixed;
        width: 100%;
        height: 100vh;
        left: 0;
        top: 0;
        z-index: 999;
        background: rgba(15, 23, 36, 0.98);
        border-right: none;
        border-radius: 0;
        flex-direction: column;
      }

      .left-sidebar.mobile-show { 
        display: flex;
      }

      .left-sidebar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.3);
        z-index: -1;
        pointer-events: none;
      }

      /* èŠå¤©åŒºå æ»¡ */
      .chat-main { 
        width: 100%;
        flex: 1;
      }

      /* èŠå¤©å¤´éƒ¨ */
      .chat-header {
        padding: 12px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      }

      .chat-header h3 {
        font-size: 13px;
        margin: 0;
      }

      .chat-header-info {
        font-size: 10px;
      }

      /* æ¶ˆæ¯åŒº */
      #messagesArea { 
        padding: 12px;
        gap: 10px;
        font-size: 13px;
      }

      .msg-bubble { 
        max-width: 85%;
        padding: 8px 12px;
        font-size: 13px;
      }

      .msg-meta {
        font-size: 10px;
      }

      .msg-bubble img {
        max-width: 100%;
        border-radius: 6px;
      }

      .msg-bubble audio {
        width: 100%;
        max-width: 100%;
        height: 28px;
      }

      /* è¾“å…¥åŒº */
      .input-area {
        padding: 8px 12px;
        gap: 8px;
        background: rgba(255, 255, 255, 0.01);
      }

      .input-toolbar {
        gap: 6px;
      }

      .icon-btn {
        width: 32px;
        height: 32px;
        font-size: 14px;
      }

      textarea#msgInput {
        min-height: 32px;
        max-height: 100px;
        padding: 6px 10px;
        font-size: 13px;
      }

      #sendBtn {
        padding: 6px 14px;
        font-size: 12px;
      }

      #inputBox {
        gap: 6px;
      }

      /* å¥½å‹åˆ—è¡¨ç§»åŠ¨ç«¯æ ·å¼ */
      .user-profile {
        padding: 16px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      }

      .avatar {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }

      .user-info {
        flex: 1;
      }

      .user-name {
        font-size: 12px;
      }

      .user-status {
        font-size: 10px;
      }

      .sidebar-section-title {
        font-size: 10px;
        padding: 10px 12px 4px 12px;
      }

      #friendsList {
        flex: 1;
        overflow-y: auto;
        padding: 4px 0;
      }

      .friend-item {
        padding: 8px 12px;
        gap: 8px;
      }

      .friend-item .avatar-sm {
        width: 28px;
        height: 28px;
      }

      .friend-name {
        font-size: 11px;
      }

      .add-friend-btn {
        width: calc(100% - 20px);
        margin: 8px 10px 10px 10px;
        padding: 8px;
        font-size: 11px;
      }

      /* è¡¨æƒ…é€‰æ‹©å™¨ */
      .emoji-picker-container {
        bottom: auto;
        top: 50px;
        left: 8px;
        max-height: 200px;
        overflow-y: auto;
        grid-template-columns: repeat(5, 1fr) !important;
      }

      .emoji-item {
        width: 28px;
        height: 28px;
        font-size: 20px;
      }

      /* è”ç³»æ–¹å¼èœå• */
      .contact-menu {
        top: auto;
        bottom: 50px;
        right: auto;
        left: 12px;
        min-width: auto;
        width: calc(100% - 24px);
      }

      .contact-item {
        padding: 10px 12px;
        font-size: 11px;
      }

      .contact-label {
        font-size: 10px;
      }

      /* å›¾ç‰‡æ”¾å¤§ */
      .image-modal img {
        max-width: 95%;
        max-height: 95%;
      }

      /* éšè—å¥½å‹åˆ—è¡¨çš„æ»šåŠ¨æ¡ */
      #friendsList::-webkit-scrollbar {
        width: 4px;
      }

      #friendsList::-webkit-scrollbar-track {
        background: transparent;
      }

      #friendsList::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
      }

      /* æ¶ˆæ¯åŒºæ»šåŠ¨æ¡ */
      #messagesArea::-webkit-scrollbar {
        width: 4px;
      }

      #messagesArea::-webkit-scrollbar-track {
        background: transparent;
      }

      #messagesArea::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
      }
    }


    /* === è¶…å°å±æ‰‹æœºï¼ˆ480pxä»¥ä¸‹ï¼‰ === */
    @media (max-width: 480px) {
      #authPanel {
        padding: 16px 12px;
      }

      .auth-title {
        font-size: 20px;
        margin: 12px 0 16px 0;
      }

      .form-group input {
        padding: 10px 12px;
        font-size: 13px;
      }

      .auth-btn {
        padding: 10px 12px;
        font-size: 13px;
      }

      .auth-tabs {
        gap: 6px;
      }

      .auth-tab {
        padding: 8px 6px;
        font-size: 11px;
      }

      .chat-header {
        padding: 10px;
      }

      .chat-header h3 {
        font-size: 12px;
      }

      #messagesArea {
        padding: 10px;
        gap: 8px;
      }

      .msg-bubble {
        max-width: 90%;
        padding: 6px 10px;
        font-size: 12px;
      }

      .input-area {
        padding: 6px 10px;
      }

      textarea#msgInput {
        min-height: 30px;
        padding: 4px 8px;
        font-size: 12px;
      }

      #sendBtn {
        padding: 4px 12px;
        font-size: 11px;
      }

      .icon-btn {
        width: 28px;
        height: 28px;
        font-size: 12px;
      }
    }
    /* æ¯›ç»ç’ƒ æ–‡ä»¶å‘é€é¢æ¿ */
    .file-panel{position:fixed;right:24px;bottom:24px;width:340px;border-radius:12px;padding:14px;background:rgba(255,255,255,0.04);backdrop-filter: blur(12px);box-shadow:0 8px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.06);color:#e7f0ff;z-index:1500}
    .file-panel .file-list{margin-top:8px;display:flex;flex-direction:column;gap:8px;max-height:220px;overflow:auto}
    .file-panel .file-item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;background:rgba(255,255,255,0.02)}
    .file-panel .file-item img{max-width:64px;max-height:48px;border-radius:6px;object-fit:cover}
    .file-panel .file-actions{display:flex;gap:8px}
    /* Mobile overrides: improved drawer, fixed input and modal behavior */
    @media (max-width: 640px) {
      .left-sidebar {
        transform: translateX(-100%);
        transition: transform 240ms ease;
        display: flex;
        position: fixed;
        z-index: 1200;
        left: 0;
        top: 0;
        height: 100vh;
        width: 84%;
        max-width: 360px;
        background: rgba(15,23,36,0.98);
        padding-top: 60px;
      }
      .left-sidebar.mobile-show { transform: translateX(0); box-shadow: 0 12px 40px rgba(2,6,23,0.6); }

      .chat-header { position: sticky; top: 0; z-index: 1000; background: linear-gradient(180deg, rgba(11,18,32,0.9), rgba(11,18,32,0.7)); }

      .input-area {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 8px 10px;
        gap: 8px;
        z-index: 1001;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        background: rgba(2,6,23,0.95);
        box-shadow: 0 -8px 24px rgba(2,6,23,0.6);
      }

      #messagesArea { padding-bottom: 88px; }

      .icon-btn { width: 40px; height: 40px; font-size: 18px; }
      .icon-btn-small { width: 44px; height: 44px; font-size: 16px; }

      .msg-bubble { max-width: 92%; }

      /* Make modals full screen and scrollable on mobile */
      #momentsContent, #favoritesContent {
        width: 100%;
        max-width: none;
        height: 100vh;
        border-radius: 0;
        padding: 16px;
        box-sizing: border-box;
        overflow: auto;
      }
      #momentsContent button#closeMomentsBtn, #favoritesContent button#closeFavoritesBtn { right: 12px; top: 12px; }
    }
  </style>
</head>
<body>

<!-- ç™»å½•/æ³¨å†Œé¢æ¿ -->
<div id="authPanel" class="active">
  <h2 class="auth-title">Pexgram</h2>
  <div class="auth-form">
    <div style="display:flex;justify-content:center;gap:12px;margin-bottom:14px;font-size:13px;color:var(--muted)">
      <div>æ²¡æœ‰è´¦å·ï¼Ÿ<a href="#" id="toRegister" style="color:#39d7ff;text-decoration:none">ç‚¹æˆ‘æ³¨å†Œ</a></div>
      <div style="display:none">å·²æ³¨å†Œï¼Ÿ<a href="#" id="toLogin" style="color:#39d7ff;text-decoration:none">ç‚¹æˆ‘ç™»å½•</a></div>
      <div>å¿˜è®°å¯†ç ï¼Ÿ<a href="#" id="toChangePassword" style="color:#39d7ff;text-decoration:none">ä¿®æ”¹</a></div>
      <div>åŒ¿åï¼š<a href="#" id="toAnonymous" style="color:#39d7ff;text-decoration:none">ç›´æ¥è¿›å…¥</a></div>
    </div>

    <!-- ç™»å½•è¡¨å• -->
    <div id="loginForm">
      <div class="form-group">
        <label>ç”¨æˆ·å</label>
        <input type="text" id="loginUsername" placeholder="è¾“å…¥ç”¨æˆ·å">
      </div>
      <div class="form-group">
        <label>å¯†ç </label>
        <input type="password" id="loginPassword" placeholder="è¾“å…¥å¯†ç ">
      </div>
      <button class="auth-btn" id="loginBtn">ç™»å½•</button>
      <div id="loginMsg" class="auth-msg"></div>
    </div>

    <!-- æ³¨å†Œè¡¨å• -->
    <div id="registerForm" style="display: none;">
      <div class="form-group">
        <label>ç”¨æˆ·å</label>
        <input type="text" id="regUsername" placeholder="è¾“å…¥ç”¨æˆ·åï¼ˆ3-20ä¸ªå­—ç¬¦ï¼‰">
      </div>
      <div class="form-group">
        <label>å¯†ç </label>
        <input type="password" id="regPassword" placeholder="è¾“å…¥å¯†ç ï¼ˆ6ä½ä»¥ä¸Šï¼‰">
      </div>
      <div class="form-group">
        <label>ç¡®è®¤å¯†ç </label>
        <input type="password" id="regPassword2" placeholder="å†æ¬¡è¾“å…¥å¯†ç ">
      </div>
      <button class="auth-btn" id="registerBtn">æ³¨å†Œ</button>
      <div id="registerMsg" class="auth-msg"></div>
    </div>

    <!-- ä¿®æ”¹å¯†ç è¡¨å• -->
    <div id="changePasswordForm" style="display: none;">
      <div class="form-group">
        <label>ç”¨æˆ·å</label>
        <input type="text" id="cpUsername" placeholder="è¾“å…¥ç”¨æˆ·å">
      </div>
      <div class="form-group">
        <label>æ—§å¯†ç </label>
        <input type="password" id="cpOldPassword" placeholder="è¾“å…¥æ—§å¯†ç ">
      </div>
      <div class="form-group">
        <label>æ–°å¯†ç </label>
        <input type="password" id="cpNewPassword" placeholder="è¾“å…¥æ–°å¯†ç ï¼ˆ6ä½ä»¥ä¸Šï¼‰">
      </div>
      <div class="form-group">
        <label>ç¡®è®¤æ–°å¯†ç </label>
        <input type="password" id="cpNewPassword2" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
      </div>
      <button class="auth-btn" id="changePasswordBtn">ä¿®æ”¹å¯†ç </button>
      <div id="changePasswordMsg" class="auth-msg"></div>
    </div>

    <!-- åŒ¿åæ¨¡å¼ -->
    <div id="anonForm" style="display: none;">
      <p style="font-size: 12px; color: var(--muted); text-align: center; margin-bottom: 20px;">
        ä»¥åŒ¿åèº«ä»½è¿›å…¥å…¨çƒèŠå¤©å®¤ï¼Œæ— æ³•ä½¿ç”¨å¥½å‹åŠŸèƒ½ã€‚
      </p>
      <button class="auth-btn" id="anonBtn">è¿›å…¥åŒ¿åèŠå¤©</button>
    </div>
  </div>
</div>

<!-- èŠå¤©é¢æ¿ -->
<div id="chatPanel">
  <!-- å·¦ä¾§ï¼šå¥½å‹åˆ—è¡¨ -->
  <div class="left-sidebar">
    <!-- ç”¨æˆ·ä¿¡æ¯ -->
    <div class="user-profile">
      <div class="avatar" id="userAvatar">
        <input type="file" class="avatar-upload" id="avatarUpload" accept="image/*">
        <span id="avatarText">ğŸ‘¤</span>
      </div>
      <div class="user-info">
        <div class="user-name" id="currentUsername">ç”¨æˆ·</div>
        <div class="user-status" id="userStatus">åœ¨çº¿</div>
      </div>
      <div class="user-actions">
          <button class="icon-btn-small" id="settingsBtn" title="è®¾ç½®">âš™ï¸</button>
          <button class="icon-btn-small" id="logoutBtn" title="ç™»å‡º">ğŸšª</button>
      </div>
    </div>

    <!-- å¥½å‹åˆ—è¡¨ -->
    <div class="sidebar-section-title">å¥½å‹</div>
    <div id="friendsList"></div>

    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px">
      <div class="sidebar-section-title">ç¾¤ç»„</div>
      <button id="createGroupBtn" class="unified-btn" title="åˆ›å»ºç¾¤ç»„" style="background:transparent;color:var(--muted);font-size:18px;cursor:pointer;padding:6px">ï¼‹</button>
    </div>
    <div id="groupsList" style="padding:6px 12px; max-height:160px; overflow:auto; color:var(--muted);"></div>

    <div class="sidebar-section-title" style="margin-top:8px">å¥½å‹è¯·æ±‚</div>
    <div id="pendingRequests" style="padding:6px 12px; max-height:240px; overflow:auto; color:var(--muted);"></div>

    <button class="add-friend-btn unified-btn" id="addFriendBtn">+ æ·»åŠ å¥½å‹</button>
  </div>

  <!-- å³ä¾§ï¼šèŠå¤©åŒº -->
  <div class="chat-main">
    <!-- èŠå¤©å¤´éƒ¨ -->
    <div class="chat-header">
      <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
        <button class="icon-btn-small" id="menuBtn" title="èœå•" style="display: none;">â˜°</button>
        <button class="icon-btn-small" id="worldBtn" title="ä¸–ç•ŒèŠå¤©">ğŸŒ</button>
        <button class="icon-btn-small" id="momentsBtn" title="ä¸–ç•Œå¸–å­">ğŸ“°</button>
        <button class="icon-btn-small" id="backBtn" title="è¿”å›" style="display:none;">â†©</button>
        <button class="icon-btn-small" id="favoritesBtn" title="æ”¶è—">â˜…</button>
        <div>
          <h3 id="chatTitle">å…¨çƒèŠå¤©</h3>
          <div class="chat-header-info" id="chatInfo">å®æ—¶èŠå¤©</div>
        </div>
      </div>
      <button class="contact-btn" id="contactBtn" title="è”ç³»æ–¹å¼">ğŸ“‹</button>
      <div class="contact-menu" id="contactMenu">
        <div class="contact-item">
          <span class="contact-label">æ‰‹æœº:</span>
          <span class="contact-text">18630399822</span>
        </div>
        <div class="contact-item">
          <span class="contact-label">å¾®ä¿¡:</span>
          <span class="contact-text">pwwanghe</span>
        </div>
        <div class="contact-item">
          <span class="contact-label">é‚®ä»¶:</span>
          <span class="contact-text">pwwanghe@outlook.com</span>
        </div>
        <div class="contact-item">
          <span class="contact-label">Telegram:</span>
          <span class="contact-text">@pwerngw</span>
        </div>
      </div>
    </div>

    <!-- æ¶ˆæ¯åŒº -->
    <div id="messagesArea"></div>

    <!-- è¾“å…¥åŒº -->
    <div class="input-area">
      <div class="input-toolbar">
        <button class="icon-btn" id="emojiBtn" title="Emoji">ğŸ˜Š</button>
        <div id="emojiPicker" class="emoji-picker-container"></div>

        <button class="icon-btn" id="uploadImgBtn" title="ä¸Šä¼ å›¾ç‰‡">ğŸ–¼ï¸</button>
        <input type="file" id="imgInput" class="hidden-input" accept="image/*">
        
        <button class="icon-btn" id="uploadVideoBtn" title="ä¸Šä¼ è§†é¢‘">ğŸ“¹</button>
        <input type="file" id="videoInput" class="hidden-input" accept="video/*">

        <button class="icon-btn" id="gifBtn" title="å‘é€ GIF">G</button>

        <button class="icon-btn" id="locationBtn" title="å‘é€åæ ‡">ğŸ“</button>

        <button class="icon-btn" id="uploadFileBtn" title="ä¸Šä¼ æ–‡ä»¶">ğŸ“</button>
        <input type="file" id="fileInput" class="hidden-input">

        <button class="icon-btn" id="recordBtn" title="å½•éŸ³(Bug)">ğŸ¤</button>
      </div>

      <div id="inputBox">
        <div class="input-wrapper">
          <textarea id="msgInput" placeholder="è¾“å…¥æ¶ˆæ¯... (Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ)" maxlength="2000"></textarea>
        </div>
        <button id="sendBtn">å‘é€</button>
      </div>
    </div>
  </div>
</div>

<!-- å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡† -->
<div class="image-modal" id="imageModal">
  <img id="modalImage" src="" alt="æ”¾å¤§å›¾ç‰‡">
</div>

<!-- è®¾ç½®æ¨¡æ€æ¡† -->
<div class="image-modal" id="settingsModal" style="padding:20px;">
  <div style="position:relative; background:rgba(0,0,0,0.6); padding:12px; border-radius:10px; width:90%; max-width:420px; color:var(--text);">
    <button id="closeSettingsBtn" title="å…³é—­" style="position:absolute; right:10px; top:8px; background:transparent; border:none; color:var(--text); font-size:20px; cursor:pointer;">Ã—</button>
    <h3 style="margin:0 0 8px 0;">è®¾ç½®</h3>
    <div style="margin-bottom:8px;">
      <label><input type="checkbox" id="settingNotifyCheckbox" /> æ¥æ”¶æ¶ˆæ¯é€šçŸ¥</label>
    </div>
    <div style="display:flex; gap:8px; margin-top:8px;">
      <button id="saveSettingsBtn" class="auth-btn" style="padding:8px 12px;">ä¿å­˜è®¾ç½®</button>
      <button id="deleteAccountBtn" class="auth-btn" style="background:#ff5656;">æ³¨é”€è´¦å·</button>
    </div>
    <div id="settingsHint" style="margin-top:8px; color:var(--muted); font-size:13px;"></div>
  </div>
</div>

<div class="image-modal" id="momentsModal" style="padding:20px;">
  <div id="momentsContent" style="position:relative; background:rgba(0,0,0,0.6); padding:12px; border-radius:10px; width:90%; max-width:800px;">
    <button id="closeMomentsBtn" title="å…³é—­" style="position:absolute; right:10px; top:8px; background:transparent; border:none; color:var(--text); font-size:20px; cursor:pointer;">Ã—</button>
    <h3 style="margin:0 0 8px 0;">ä¸–ç•Œå¸–å­</h3>
    <div style="margin-bottom:8px; display:flex; gap:8px;">
      <input id="momentText" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." style="flex:1; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.08); background:transparent; color:var(--text);">
      <button id="postMomentBtn" class="auth-btn" style="padding:8px 12px;">å‘å¸ƒ</button>
    </div>
    <div id="momentsList" style="max-height:60vh; overflow:auto;"></div>
  </div>
</div>

<div class="image-modal" id="favoritesModal" style="padding:20px;">
  <div id="favoritesContent" style="position:relative; background:rgba(0,0,0,0.6); padding:12px; border-radius:10px; width:90%; max-width:800px;">
    <button id="closeFavoritesBtn" title="å…³é—­" style="position:absolute; right:10px; top:8px; background:transparent; border:none; color:var(--text); font-size:20px; cursor:pointer;">Ã—</button>
    <h3 style="margin:0 0 8px 0;">æˆ‘çš„æ”¶è—</h3>
    <div id="favoritesList" style="max-height:60vh; overflow:auto;"></div>
  </div>
</div>

<!-- æ¯›ç»ç’ƒ æ–‡ä»¶å‘é€é¢æ¿ï¼ˆå¯æ‹–æ‹½/é€‰æ‹©å¤šæ–‡ä»¶ï¼‰ -->
<div class="file-panel" id="filePanel" style="display:none">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div style="font-weight:700">å‘é€æ–‡ä»¶</div>
    <div style="font-size:12px;opacity:0.8">æ‹–æ”¾æˆ–é€‰æ‹©æ–‡ä»¶</div>
  </div>
  <label style="margin-top:10px;display:block;padding:10px;border-radius:10px;border:1px dashed rgba(255,255,255,0.06);cursor:pointer;text-align:center;">ç‚¹å‡»æˆ–æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤<input id="filePanelInput" type="file" multiple style="display:none"></label>
  <div class="file-list" id="filePanelList"></div>
  <div style="display:flex;justify-content:flex-end;margin-top:10px"><button id="filePanelSend" class="auth-btn" style="padding:8px 12px">å‘é€æ‰€é€‰</button></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, onValue, set, get, update, query, limitToLast } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAlOYUdwcNWWueaj7X9RdzzkAk_r-_JWL8",
    authDomain: "pexchatweb.firebaseapp.com",
    databaseURL: "https://pexchatweb-default-rtdb.firebaseio.com",
    projectId: "pexchatweb",
    storageBucket: "pexchatweb.firebasestorage.app",
    messagingSenderId: "157034955766",
    appId: "1:157034955766:web:076f39819c081d73b8fdd7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // === çŠ¶æ€ç®¡ç† ===
  let currentUser = null; // { uid, username, avatar, isAnonymous }
  let currentChatId = 'global';
  let prevChatId = null;
  let mediaRecorder = null;
  let mediaStream = null;
  let recordingChunks = [];
  let isRecording = false;

  // === UI å…ƒç´  ===
  const authPanel = document.getElementById('authPanel');
  const chatPanel = document.getElementById('chatPanel');
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const anonForm = document.getElementById('anonForm');
  const toRegister = document.getElementById('toRegister');
  const toLogin = document.getElementById('toLogin');
  const toChangePassword = document.getElementById('toChangePassword');
  const toAnonymous = document.getElementById('toAnonymous');
  const changePasswordForm = document.getElementById('changePasswordForm');
  const changePasswordBtn = document.getElementById('changePasswordBtn');

  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');
  const messagesArea = document.getElementById('messagesArea');
  const friendsList = document.getElementById('friendsList');
  const currentUsername = document.getElementById('currentUsername');
  const userStatus = document.getElementById('userStatus');
  const logoutBtn = document.getElementById('logoutBtn');
  const chatTitle = document.getElementById('chatTitle');
  const chatInfo = document.getElementById('chatInfo');

  const uploadImgBtn = document.getElementById('uploadImgBtn');
  const imgInput = document.getElementById('imgInput');
  const uploadVideoBtn = document.getElementById('uploadVideoBtn');
  const videoInput = document.getElementById('videoInput');
  const gifBtn = document.getElementById('gifBtn');
  const locationBtn = document.getElementById('locationBtn');
  const uploadFileBtn = document.getElementById('uploadFileBtn');
  const fileInput = document.getElementById('fileInput');
  const recordBtn = document.getElementById('recordBtn');
  const addFriendBtn = document.getElementById('addFriendBtn');
  const userAvatar = document.getElementById('userAvatar');
  const avatarText = document.getElementById('avatarText');
  const avatarUpload = document.getElementById('avatarUpload');
  const emojiBtn = document.getElementById('emojiBtn');
  const emojiPicker = document.getElementById('emojiPicker');
  const contactBtn = document.getElementById('contactBtn');
  const contactMenu = document.getElementById('contactMenu');
  

  // === ç§»åŠ¨ç«¯èœå•æŒ‰é’® ===
  const menuBtn = document.getElementById('menuBtn');
  const worldBtn = document.getElementById('worldBtn');
  const momentsBtn = document.getElementById('momentsBtn');
  const backBtn = document.getElementById('backBtn');

  function updateMenuButton() {
    const isSmall = window.innerWidth <= 640;
    if (menuBtn) {
      menuBtn.style.display = isSmall ? 'flex' : 'none';
    }
  }

  // åˆå§‹è®¾ç½®
  updateMenuButton();

  // å“åº”çª—å£å¤§å°å˜åŒ–
  window.addEventListener('resize', updateMenuButton);

  // èœå•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  if (menuBtn) {
    menuBtn.addEventListener('click', () => {
      const sidebar = document.querySelector('.left-sidebar');
      if (sidebar) {
        sidebar.classList.toggle('mobile-show');
      }
    });
  }

  if (worldBtn) {
    worldBtn.addEventListener('click', () => {
      loadGlobalChat();
    });
  }

  // ç‚¹å‡»æ¶ˆæ¯åŒºå…³é—­ä¾§è¾¹æ 
  messagesArea.addEventListener('click', () => {
    const sidebar = document.querySelector('.left-sidebar');
    if (sidebar && window.innerWidth <= 640) {
      sidebar.classList.remove('mobile-show');
    }
  });

  // === è®¤è¯ç›¸å…³ ===
  document.getElementById('loginBtn').addEventListener('click', login);
  document.getElementById('registerBtn').addEventListener('click', register);
  document.getElementById('changePasswordBtn').addEventListener('click', changePassword);
  document.getElementById('anonBtn').addEventListener('click', () => enterAnonymous());

  // è¿æ¥å¼ç™»å½•/æ³¨å†Œåˆ‡æ¢é€»è¾‘ï¼ˆé€šè¿‡é“¾æ¥åˆ‡æ¢è¡¨å•æ˜¾ç¤ºï¼‰
  function showLogin() {
    loginForm.style.display = 'flex';
    registerForm.style.display = 'none';
    changePasswordForm.style.display = 'none';
    anonForm.style.display = 'none';
    if (toLogin) toLogin.parentElement.style.display = 'none';
    if (toRegister) toRegister.parentElement.style.display = '';
  }
  function showRegister() {
    loginForm.style.display = 'none';
    registerForm.style.display = 'flex';
    changePasswordForm.style.display = 'none';
    anonForm.style.display = 'none';
    if (toLogin) toLogin.parentElement.style.display = '';
    if (toRegister) toRegister.parentElement.style.display = 'none';
  }
  function showChangePassword() {
    loginForm.style.display = 'none';
    registerForm.style.display = 'none';
    changePasswordForm.style.display = 'flex';
    anonForm.style.display = 'none';
    if (toLogin) toLogin.parentElement.style.display = '';
    if (toRegister) toRegister.parentElement.style.display = '';
  }

  if (toRegister) toRegister.addEventListener('click', (e) => { e.preventDefault(); showRegister(); });
  if (toLogin) toLogin.addEventListener('click', (e) => { e.preventDefault(); showLogin(); });
  if (toChangePassword) toChangePassword.addEventListener('click', (e) => { e.preventDefault(); showChangePassword(); });
  if (toAnonymous) toAnonymous.addEventListener('click', (e) => { e.preventDefault(); enterAnonymous(); });

  // åˆå§‹æ˜¾ç¤ºç™»å½•è¡¨å•
  showLogin();

  async function register() {
    const username = document.getElementById('regUsername').value.trim();
    const password = document.getElementById('regPassword').value;
    const password2 = document.getElementById('regPassword2').value;
    const msg = document.getElementById('registerMsg');

    if (!username || username.length < 3 || username.length > 20) {
      msg.textContent = 'ç”¨æˆ·åéœ€ä¸º 3-20 ä¸ªå­—ç¬¦';
      return;
    }
    if (!password || password.length < 6) {
      msg.textContent = 'å¯†ç éœ€è‡³å°‘ 6 ä½';
      return;
    }
    if (password !== password2) {
      msg.textContent = 'ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´';
      return;
    }

    try {
      const usersRef = ref(db, 'users');
      const snapshot = await get(usersRef);
      const users = snapshot.val() || {};

      for (const uid in users) {
        if (users[uid].username === username) {
          msg.textContent = 'ç”¨æˆ·åå·²è¢«æ³¨å†Œ';
          return;
        }
      }

      const uid = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      const passwordHash = btoa(username + ':' + password);

      await set(ref(db, `users/${uid}`), {
        username,
        passwordHash,
        avatar: 'ğŸ‘¤',
        friends: [],
        createdAt: Date.now()
      });

      msg.textContent = 'æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•';
      setTimeout(() => {
        showLogin();
        document.getElementById('loginUsername').value = username;
        document.getElementById('loginPassword').value = '';
      }, 1000);
    } catch (err) {
      msg.textContent = 'æ³¨å†Œå¤±è´¥ï¼š' + err.message;
    }
  }

  async function login() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    const msg = document.getElementById('loginMsg');

    if (!username || !password) {
      msg.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
      return;
    }

    try {
      const usersRef = ref(db, 'users');
      const snapshot = await get(usersRef);
      const users = snapshot.val() || {};

      let foundUser = null;
      for (const uid in users) {
        if (users[uid].username === username) {
          const expectedHash = btoa(username + ':' + password);
          if (users[uid].passwordHash === expectedHash) {
            foundUser = { uid, ...users[uid] };
          }
          break;
        }
      }

      if (!foundUser) {
        msg.textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
        return;
      }

      currentUser = { uid: foundUser.uid, username: foundUser.username, avatar: foundUser.avatar, isAnonymous: false };
      enterChat();
    } catch (err) {
      msg.textContent = 'ç™»å½•å¤±è´¥ï¼š' + err.message;
    }
  }

  async function changePassword() {
    const username = document.getElementById('cpUsername').value.trim();
    const oldPassword = document.getElementById('cpOldPassword').value;
    const newPassword = document.getElementById('cpNewPassword').value;
    const newPassword2 = document.getElementById('cpNewPassword2').value;
    const msg = document.getElementById('changePasswordMsg');

    if (!username || !oldPassword || !newPassword || !newPassword2) {
      msg.textContent = 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µ';
      return;
    }
    if (newPassword.length < 6) {
      msg.textContent = 'æ–°å¯†ç éœ€è‡³å°‘ 6 ä½';
      return;
    }
    if (newPassword !== newPassword2) {
      msg.textContent = 'ä¸¤æ¬¡æ–°å¯†ç ä¸ä¸€è‡´';
      return;
    }

    try {
      const usersRef = ref(db, 'users');
      const snapshot = await get(usersRef);
      const users = snapshot.val() || {};

      let foundUser = null;
      for (const uid in users) {
        if (users[uid].username === username) {
          const expectedHash = btoa(username + ':' + oldPassword);
          if (users[uid].passwordHash === expectedHash) {
            foundUser = { uid, ...users[uid] };
          }
          break;
        }
      }

      if (!foundUser) {
        msg.textContent = 'ç”¨æˆ·åæˆ–æ—§å¯†ç é”™è¯¯';
        return;
      }

      const newHash = btoa(username + ':' + newPassword);
      await update(ref(db, `users/${foundUser.uid}`), { passwordHash: newHash });

      msg.textContent = 'å¯†ç ä¿®æ”¹æˆåŠŸï¼';
      msg.style.color = '#39d7ff';
      setTimeout(() => {
        showLogin();
        document.getElementById('loginUsername').value = username;
        document.getElementById('loginPassword').value = '';
        document.getElementById('cpUsername').value = '';
        document.getElementById('cpOldPassword').value = '';
        document.getElementById('cpNewPassword').value = '';
        document.getElementById('cpNewPassword2').value = '';
        msg.style.color = 'var(--danger)';
        msg.textContent = '';
      }, 1500);
    } catch (err) {
      msg.textContent = 'ä¿®æ”¹å¤±è´¥ï¼š' + err.message;
    }
  }

  function enterAnonymous() {
    currentUser = { uid: 'anon_' + Date.now(), username: 'åŒ¿å_' + Math.floor(Math.random() * 10000), avatar: 'ğŸ‘¤', isAnonymous: true };
    enterChat();
  }

  function enterChat() {
    authPanel.classList.add('hidden');
    chatPanel.classList.add('active');
    currentUsername.textContent = currentUser.username;
    userStatus.textContent = currentUser.isAnonymous ? 'åŒ¿å' : 'åœ¨çº¿';
    
    // å¤„ç†å¤´åƒæ˜¾ç¤º
    if (currentUser.avatar && currentUser.avatar.startsWith('data:')) {
      // æ˜¯å›¾ç‰‡æ•°æ®URLï¼Œæ˜¾ç¤ºä¸ºèƒŒæ™¯å›¾ç‰‡
      avatarText.textContent = '';
      userAvatar.style.backgroundImage = `url(${currentUser.avatar})`;
      userAvatar.style.backgroundSize = 'cover';
    } else {
      // æ˜¯emojiæˆ–å…¶ä»–æ–‡å­—
      avatarText.textContent = currentUser.avatar || 'ğŸ‘¤';
      userAvatar.style.backgroundImage = 'none';
    }
    
    // ä¿å­˜ç™»å½•çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
    if (!currentUser.isAnonymous) {
      localStorage.setItem('pexgram_user', JSON.stringify(currentUser));
    } else {
      localStorage.removeItem('pexgram_user');
    }
    
    loadGlobalChat();
    if (!currentUser.isAnonymous) {
      loadFriends();
      loadPendingRequestsUI();
      addFriendBtn.style.display = 'block';
      loadGroups();
    } else {
      addFriendBtn.style.display = 'none';
    }
    // è¯·æ±‚å¹¶å‡†å¤‡æ¡Œé¢é€šçŸ¥æƒé™
    try { ensureNotification(); } catch(e) { console.warn('ensureNotification error', e); }
  }

  // === æ¶ˆæ¯ç›¸å…³ ===
  // å­˜å‚¨å·²æ˜¾ç¤ºçš„æ¶ˆæ¯ keyï¼Œé¿å…é‡å¤
  const displayedMsgKeys = new Set();

  function loadGlobalChat() {
    messagesArea.innerHTML = '';
    displayedMsgKeys.clear();
    currentChatId = 'global';
    chatTitle.textContent = 'å…¨çƒèŠå¤©';
    chatInfo.textContent = 'æ‰€æœ‰ç”¨æˆ·å®æ—¶èŠå¤©';

    // å…ˆè·å–æ‰€æœ‰å†å²æ¶ˆæ¯
    const messagesRef = ref(db, 'chats/global/messages');
    get(messagesRef).then(snapshot => {
      if (snapshot.exists()) {
        const data = snapshot.val();
        // æŒ‰æ—¶é—´æ’åº
        const sorted = Object.entries(data)
          .map(([key, val]) => ({ key, ...val }))
          .sort((a, b) => (a.time || 0) - (b.time || 0));
        
        sorted.forEach(msg => {
          appendMessage(msg, msg.key);
          displayedMsgKeys.add(msg.key);
        });
      }
      
      // ç„¶åç›‘å¬æ–°æ¶ˆæ¯
      onChildAdded(ref(db, 'chats/global/messages'), (snapshot) => {
        const key = snapshot.key;
        if (!displayedMsgKeys.has(key)) {
          displayedMsgKeys.add(key);
          const msg = snapshot.val();
          appendMessage(msg, key);
        }
      });
    });
  }

  function appendMessage(msg, key) {
    if (!msg) return;
    const div = document.createElement('div');
    div.className = 'msg' + (msg.uid === currentUser.uid ? ' me' : '');
    div.dataset.key = key;
    div.dataset.chat = currentChatId;
    
    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = 'msg-bubble';

    // å¦‚æœæ¶ˆæ¯è¢«æ’¤å›
    if (msg.recalled) {
      bubbleDiv.textContent = 'å·²æ’¤å›';
    } else {
      // å…ˆæ·»åŠ å†…å®¹
      if (msg.type === 'image' && msg.data) {
        const img = document.createElement('img');
        img.src = msg.data;
        img.alt = 'image';
        img.style.maxWidth = '100%';
        img.style.height = 'auto';
        img.style.display = 'block';
        bubbleDiv.appendChild(img);
        attachImageClickListener(img);

        // ä¸‹è½½æŒ‰é’®
        const dl = document.createElement('a');
        dl.href = msg.data;
        dl.download = msg.fileName || 'image.png';
        dl.textContent = ' ä¸‹è½½';
        dl.style.display = 'inline-block';
        dl.style.marginLeft = '8px';
        bubbleDiv.appendChild(dl);
      } else if (msg.type === 'gif' && msg.url) {
        const img = document.createElement('img');
        img.src = msg.url;
        img.alt = 'gif';
        img.style.maxWidth = '100%';
        img.style.display = 'block';
        bubbleDiv.appendChild(img);
        attachImageClickListener(img);
      } else if (msg.type === 'video' && msg.data) {
        const v = document.createElement('video');
        v.controls = true;
        v.src = msg.data;
        v.style.maxWidth = '100%';
        bubbleDiv.appendChild(v);
        const dlv = document.createElement('a');
        dlv.href = msg.data;
        dlv.download = msg.fileName || 'video.mp4';
        dlv.textContent = ' ä¸‹è½½è§†é¢‘';
        dlv.style.display = 'inline-block';
        dlv.style.marginLeft = '8px';
        bubbleDiv.appendChild(dlv);
      } else if (msg.type === 'audio' && msg.data) {
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.src = msg.data;
        audio.style.width = '100%';
        audio.style.maxWidth = 'none';
        bubbleDiv.appendChild(audio);
      } else if (msg.type === 'file' && msg.fileUrl) {
        const link = document.createElement('a');
        link.href = msg.fileUrl;
        link.textContent = msg.fileName || 'ä¸‹è½½æ–‡ä»¶';
        link.target = '_blank';
        bubbleDiv.appendChild(link);
      } else if (msg.type === 'location' && msg.mapsUrl) {
        const a = document.createElement('a');
        a.href = msg.mapsUrl;
        a.textContent = `ğŸ“ ä½ç½®ï¼š ${msg.lat.toFixed(5)}, ${msg.lon.toFixed(5)}`;
        a.target = '_blank';
        bubbleDiv.appendChild(a);
      } else {
        // å°†æ–‡æœ¬ä¸­çš„ URL è½¬ä¸ºå¯ç‚¹å‡»é“¾æ¥
        const text = msg.text || '';
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const html = text.replace(urlRegex, (m) => `<a href="${m}" target="_blank">${m}</a>`);
        const wrap = document.createElement('div');
        wrap.innerHTML = html;
        bubbleDiv.appendChild(wrap);
      }
    }

    // ç»“æ„ï¼šå¦‚æœæ˜¯åˆ«äººçš„æ¶ˆæ¯ï¼Œå…ˆæ˜¾ç¤ºç”¨æˆ·åï¼Œå†æ˜¾ç¤ºæ°”æ³¡ï¼›è‡ªå·±çš„æ¶ˆæ¯åªæ˜¾ç¤ºæ°”æ³¡
    if (msg.uid !== currentUser.uid) {
      const metaDiv = document.createElement('div');
      metaDiv.className = 'msg-meta';
      metaDiv.textContent = msg.username || 'æœªçŸ¥ç”¨æˆ·';
      div.appendChild(metaDiv);
    }

    // æ“ä½œæŒ‰é’®ï¼šæ”¶è—ã€æ’¤å›ï¼ˆè‡ªå·±çš„æ¶ˆæ¯ï¼‰
    const actionBar = document.createElement('div');
    actionBar.style.marginTop = '6px';
    actionBar.style.display = 'flex';
    actionBar.style.gap = '8px';

    // æ”¶è—æŒ‰é’®
    const favBtn = document.createElement('button');
    favBtn.textContent = `â˜† ${msg.favorites ? msg.favorites.length : 0}`;
    favBtn.style.fontSize = '12px';
    favBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const msgRef = ref(db, `chats/${currentChatId}/messages/${key}/favorites`);
      const snap = await get(msgRef);
      const arr = snap.val() || [];
      const idx = arr.indexOf(currentUser.uid);
      if (idx === -1) arr.push(currentUser.uid);
      else arr.splice(idx, 1);
      update(ref(db, `chats/${currentChatId}/messages/${key}`), { favorites: arr });
    });
    actionBar.appendChild(favBtn);

    // æ’¤å›ï¼ˆä»…ä½œè€…å¯è§ï¼‰
    if (msg.uid === currentUser.uid && !msg.recalled) {
      const recallBtn = document.createElement('button');
      recallBtn.textContent = 'æ’¤å›';
      recallBtn.style.fontSize = '12px';
      recallBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (!confirm('ç¡®å®šæ’¤å›æ­¤æ¶ˆæ¯ï¼Ÿ')) return;
        update(ref(db, `chats/${currentChatId}/messages/${key}`), { recalled: true, recalledAt: Date.now() });
      });
      actionBar.appendChild(recallBtn);
    }

    // å°†æ”¶è—æ•°å®æ—¶æ›´æ–°ï¼ˆç›‘å¬å½“å‰ message favoritesï¼‰
    const favPath = ref(db, `chats/${currentChatId}/messages/${key}/favorites`);
    onValue(favPath, (s) => {
      const arr = s.val() || [];
      favBtn.textContent = `â˜† ${arr.length}`;
    });

    div.appendChild(bubbleDiv);
    div.appendChild(actionBar);
    messagesArea.appendChild(div);
    messagesArea.scrollTop = messagesArea.scrollHeight;
    // æ¡Œé¢é€šçŸ¥ï¼šæ¥è‡ªä»–äººçš„æ¶ˆæ¯è§¦å‘é€šçŸ¥ï¼ˆè¯·æ±‚æƒé™å°†åœ¨ç™»å½•æ—¶å‘èµ·ï¼‰
    try {
      if (msg && msg.uid && currentUser && msg.uid !== currentUser.uid) {
        const title = msg.username || 'æ–°æ¶ˆæ¯';
        const body = msg.text || (msg.type ? '[' + msg.type + ']' : 'æ”¶åˆ°ä¸€æ¡æ¶ˆæ¯');
        showNotification(title, body);
      }
    } catch (e) { console.warn('notify failed', e); }
  }

    // === æ”¶è—æŸ¥çœ‹åŠŸèƒ½ ===
    const favoritesBtnEl = document.getElementById('favoritesBtn');
    const favoritesModal = document.getElementById('favoritesModal');
    const favoritesList = document.getElementById('favoritesList');

    favoritesBtnEl.addEventListener('click', (e) => {
      e.stopPropagation();
      // è®°å½•å½“å‰èŠå¤©ï¼Œä»¥ä¾¿è¿”å›
      prevChatId = currentChatId;
      if (backBtn) backBtn.style.display = 'inline-flex';
      favoritesModal.classList.toggle('show');
      if (favoritesModal.classList.contains('show')) loadFavorites();
    });

    // è¿”å›ä¸Šä¸€ä¸ªèŠå¤©
    if (backBtn) {
      backBtn.addEventListener('click', () => {
        if (!prevChatId) return;
        openChatById(prevChatId, null);
        prevChatId = null;
        backBtn.style.display = 'none';
        // å¦‚æœæ”¶è—å¼¹çª—æ‰“å¼€åˆ™å…³é—­
        if (favoritesModal.classList.contains('show')) favoritesModal.classList.remove('show');
      });
    }

    // å…³é—­æŒ‰é’®å’ŒèƒŒæ™¯ç‚¹å‡»è¡Œä¸º for favorites
    const closeFavoritesBtn = document.getElementById('closeFavoritesBtn');
    const favoritesContent = document.getElementById('favoritesContent');
    closeFavoritesBtn.addEventListener('click', () => favoritesModal.classList.remove('show'));
    favoritesModal.addEventListener('click', () => favoritesModal.classList.remove('show'));
    favoritesContent.addEventListener('click', (e) => e.stopPropagation());

    async function loadFavorites() {
      favoritesList.innerHTML = '';
      const snap = await get(ref(db, 'chats'));
      const chats = snap.val() || {};
      const items = [];
      for (const chatId in chats) {
        const msgs = chats[chatId].messages || {};
        for (const k in msgs) {
          const m = msgs[k];
          if (m && m.favorites && Array.isArray(m.favorites) && m.favorites.includes(currentUser.uid)) {
            items.push({ chatId, key: k, msg: m });
          }
        }
      }
      items.sort((a, b) => (b.msg.time || 0) - (a.msg.time || 0));
      if (items.length === 0) {
        favoritesList.innerHTML = '<div style="padding:8px;color:var(--muted);">æš‚æ— æ”¶è—</div>';
        return;
      }
      items.forEach(it => {
        const d = document.createElement('div');
        d.style.padding = '8px';
        d.style.borderBottom = '1px solid rgba(255,255,255,0.04)';
        const textPreview = it.msg.type === 'text' ? (it.msg.text || '') : (`[${it.msg.type}]`);
        d.innerHTML = `<div style="font-weight:600">${it.msg.username || 'æœªçŸ¥'}</div><div style="font-size:13px;margin:6px 0">${escapeHtml(textPreview)}</div>`;

        const goto = document.createElement('button');
        goto.textContent = 'è·³è½¬';
        goto.style.marginRight = '8px';
        goto.addEventListener('click', () => {
          openChatById(it.chatId, it.key);
          favoritesModal.classList.remove('show');
        });

        const unfav = document.createElement('button');
        unfav.textContent = 'å–æ¶ˆæ”¶è—';
        unfav.addEventListener('click', async () => {
          const favRef = ref(db, `chats/${it.chatId}/messages/${it.key}/favorites`);
          const s = await get(favRef);
          let arr = s.val() || [];
          const idx = arr.indexOf(currentUser.uid);
          if (idx !== -1) arr.splice(idx, 1);
          await update(ref(db, `chats/${it.chatId}/messages/${it.key}`), { favorites: arr });
          loadFavorites();
        });

        d.appendChild(goto);
        d.appendChild(unfav);
        favoritesList.appendChild(d);
      });
    }

    function escapeHtml(s) {
      return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function openChatById(chatId, msgKey) {
      if (chatId === 'global') {
        loadGlobalChat();
        setTimeout(() => scrollToMessage(msgKey), 700);
      } else {
        const parts = chatId.split('_');
        const friendId = parts[0] === currentUser.uid ? parts[1] : parts[0];
        get(ref(db, `users/${friendId}`)).then(snap => {
          const friend = snap.val() || { username: 'ç”¨æˆ·' };
          openChat(friendId, friend.username);
          setTimeout(() => scrollToMessage(msgKey), 700);
        });
      }
    }

    function scrollToMessage(msgKey) {
      const el = [...messagesArea.querySelectorAll('.msg')].find(d => d.dataset.key === msgKey);
      if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); el.style.boxShadow = '0 0 0 3px rgba(57,215,255,0.12)'; setTimeout(() => el.style.boxShadow = '', 3000); return; }
      let tries = 0;
      const t = setInterval(() => {
        tries++; const el2 = [...messagesArea.querySelectorAll('.msg')].find(d => d.dataset.key === msgKey);
        if (el2) { el2.scrollIntoView({ behavior: 'smooth', block: 'center' }); el2.style.boxShadow = '0 0 0 3px rgba(57,215,255,0.12)'; clearInterval(t); setTimeout(() => el2.style.boxShadow = '', 3000); }
        if (tries > 8) clearInterval(t);
      }, 400);
    }

    sendBtn.addEventListener('click', sendMessage);
  msgInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  function sendMessage() {
    const text = msgInput.value.trim();
    if (!text) return;

    push(ref(db, `chats/${currentChatId}/messages`), {
      uid: currentUser.uid,
      username: currentUser.username,
      text,
      type: 'text',
      time: Date.now()
    });

    msgInput.value = '';
    autoResizeInput();
  }

  function autoResizeInput() {
    msgInput.style.height = 'auto';
    const maxHeight = 120;
    const newHeight = Math.min(msgInput.scrollHeight, maxHeight);
    msgInput.style.height = newHeight + 'px';
  }

  msgInput.addEventListener('input', autoResizeInput);

  // === å›¾ç‰‡ä¸Šä¼  ===
  uploadImgBtn.addEventListener('click', () => imgInput.click());
  imgInput.addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      push(ref(db, `chats/${currentChatId}/messages`), {
        uid: currentUser.uid,
        username: currentUser.username,
        type: 'image',
        data: reader.result,
        time: Date.now()
      });
      imgInput.value = '';
    };
    reader.readAsDataURL(file);
  });

  // === è§†é¢‘ä¸Šä¼  ===
  uploadVideoBtn.addEventListener('click', () => videoInput.click());
  videoInput.addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      push(ref(db, `chats/${currentChatId}/messages`), {
        uid: currentUser.uid,
        username: currentUser.username,
        type: 'video',
        data: reader.result,
        fileName: file.name,
        time: Date.now()
      });
      videoInput.value = '';
    };
    reader.readAsDataURL(file);
  });

  // === å‘é€ GIFï¼ˆå¤–éƒ¨ URLï¼‰ ===
  gifBtn.addEventListener('click', () => {
    const url = prompt('è¾“å…¥ GIF å›¾ç‰‡åœ°å€ï¼ˆhttp(s)://ï¼‰ï¼š');
    if (!url) return;
    push(ref(db, `chats/${currentChatId}/messages`), {
      uid: currentUser.uid,
      username: currentUser.username,
      type: 'gif',
      url,
      time: Date.now()
    });
  });

  // === å‘é€åœ°ç†ä½ç½®ï¼ˆé“¾æ¥ï¼‰ ===
  locationBtn.addEventListener('click', () => {
    if (!navigator.geolocation) {
      alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½');
      return;
    }
    locationBtn.disabled = true;
    navigator.geolocation.getCurrentPosition((pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const mapsUrl = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=18/${lat}/${lon}`;
      push(ref(db, `chats/${currentChatId}/messages`), {
        uid: currentUser.uid,
        username: currentUser.username,
        type: 'location',
        lat,
        lon,
        mapsUrl,
        time: Date.now()
      });
      locationBtn.disabled = false;
    }, (err) => {
      alert('è·å–ä½ç½®å¤±è´¥ï¼š' + err.message);
      locationBtn.disabled = false;
    }, { enableHighAccuracy: true, timeout: 10000 });
  });

  // === æ–‡ä»¶ä¸Šä¼  ===
  uploadFileBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      push(ref(db, `chats/${currentChatId}/messages`), {
        uid: currentUser.uid,
        username: currentUser.username,
        type: 'file',
        fileUrl: reader.result,
        fileName: file.name,
        time: Date.now()
      });
      fileInput.value = '';
    };
    reader.readAsDataURL(file);
  });


  function loadFriends() {
    if (currentUser.isAnonymous) return;

    const userRef = ref(db, `users/${currentUser.uid}`);
    get(userRef).then(snapshot => {
      const userData = snapshot.val();
      const friends = userData?.friends || [];

      friendsList.innerHTML = '';
      friends.forEach(friendId => {
        get(ref(db, `users/${friendId}`)).then(friendSnapshot => {
          if (!friendSnapshot.exists()) return;
          const friend = friendSnapshot.val();

          const div = document.createElement('div');
          div.className = 'friend-item';
          
          // åˆ›å»ºå¤´åƒå…ƒç´ 
          const avatarDiv = document.createElement('div');
          avatarDiv.className = 'avatar-sm';
          
              // æ›´ä¸¥æ ¼åœ°æ£€æµ‹ data URLï¼ˆé¿å…è¢«å½“ä½œæ–‡æœ¬æ’å…¥ï¼‰
              const isDataUrl = typeof friend.avatar === 'string' && /^(data:)[\w/+.-]+;base64,/.test(friend.avatar);
              if (isDataUrl) {
                // æ˜¯å›¾ç‰‡æ•°æ®ï¼Œè®¾ç½®ä¸ºèƒŒæ™¯å¹¶æ¸…é™¤æ–‡æœ¬å†…å®¹
                avatarDiv.style.backgroundImage = `url(${friend.avatar})`;
                avatarDiv.style.backgroundSize = 'cover';
                avatarDiv.style.backgroundRepeat = 'no-repeat';
                avatarDiv.textContent = '';
              } else {
                // æ˜¯ emoji æˆ–æ–‡å­—ï¼Œä½¿ç”¨æ¸å˜èƒŒæ™¯å¹¶æ˜¾ç¤ºæ–‡æœ¬
                avatarDiv.style.backgroundImage = 'none';
                avatarDiv.style.background = 'linear-gradient(135deg, #7b61ff, #39d7ff)';
                avatarDiv.textContent = friend.avatar || 'ğŸ‘¤';
              }
          
          const infoDiv = document.createElement('div');
          infoDiv.className = 'friend-info';
          infoDiv.innerHTML = `<div class="friend-name">${friend.username}</div>`;

          // æ“ä½œåŒºï¼ˆåˆ é™¤æŒ‰é’®ï¼‰
          const actionsDiv = document.createElement('div');
          actionsDiv.style.marginLeft = '8px';
          actionsDiv.style.display = 'flex';
          actionsDiv.style.gap = '6px';

          const delBtn = document.createElement('button');
          delBtn.textContent = 'åˆ é™¤';
          delBtn.title = 'åˆ é™¤å¥½å‹';
          delBtn.className = 'icon-btn-small unified-btn';
          delBtn.addEventListener('click', (ev) => {
            ev.stopPropagation();
            if (!confirm('ç¡®å®šåˆ é™¤å¥½å‹ ' + friend.username + ' å—ï¼Ÿ')) return;
            // ä»å½“å‰ç”¨æˆ·åˆ—è¡¨ä¸­ç§»é™¤
            get(ref(db, `users/${currentUser.uid}`)).then(snap => {
              const u = snap.val() || {};
              const arr = u.friends || [];
              const idx = arr.indexOf(friendId);
              if (idx !== -1) arr.splice(idx, 1);
              update(ref(db, `users/${currentUser.uid}`), { friends: arr });
            });
            // ä»å¯¹æ–¹åˆ—è¡¨ä¸­ç§»é™¤å½“å‰ç”¨æˆ·
            get(ref(db, `users/${friendId}`)).then(snap2 => {
              const u2 = snap2.val() || {};
              const arr2 = u2.friends || [];
              const idx2 = arr2.indexOf(currentUser.uid);
              if (idx2 !== -1) arr2.splice(idx2, 1);
              update(ref(db, `users/${friendId}`), { friends: arr2 });
            });
            div.remove();
          });

          actionsDiv.appendChild(delBtn);

          div.appendChild(avatarDiv);
          div.appendChild(infoDiv);
          div.appendChild(actionsDiv);

          div.addEventListener('click', () => openChat(friendId, friend.username));
          friendsList.appendChild(div);
        });
      });
    });
    }

  // === ç¾¤ç»„ç›¸å…³ï¼ˆåŠ å…¥ç¾¤èŠï¼‰ ===
  document.addEventListener('click', (e) => {
    if (e.target.matches('.join-group-btn')) {
      const btn = e.target;
      const gid = btn.dataset.id;
      const groupItem = btn.closest('.group-item');
      const groupName = groupItem ? groupItem.childNodes[0].nodeValue.trim() : gid;
      joinGroup(gid, groupName, btn);
    }
  });

  async function joinGroup(groupId, groupName, btn) {
    if (!currentUser || currentUser.isAnonymous) { alert('è¯·å…ˆç™»å½•'); return; }
    try {
      const membersRef = ref(db, `groups/${groupId}/members`);
      const snap = await get(membersRef);
      const members = snap.val() || [];
      if (members.includes(currentUser.uid)) { alert('ä½ å·²åœ¨ç¾¤å†…'); return; }
      members.push(currentUser.uid);
      await update(ref(db, `groups/${groupId}`), { members });
      // å°†ç¾¤åŠ å…¥ç”¨æˆ· groups åˆ—è¡¨
      const myGroupsRef = ref(db, `users/${currentUser.uid}/groups`);
      const mySnap = await get(myGroupsRef);
      const myGroups = mySnap.val() || [];
      if (!myGroups.includes(groupId)) myGroups.push(groupId);
      await update(ref(db, `users/${currentUser.uid}`), { groups: myGroups });
      if (btn) {
        btn.textContent = 'èŠå¤©';
        btn.disabled = false;
        btn.style.background = 'rgba(59,130,246,0.95)';
        btn.style.color = '#fff';
        btn.style.padding = '4px 8px';
        btn.addEventListener('click', () => openGroupChat(groupId, groupName));
      }
      alert('å·²åŠ å…¥ç¾¤ï¼š' + groupName);
      // è‡ªåŠ¨æ‰“å¼€åˆšåŠ å…¥çš„ç¾¤èŠ
      openGroupChat(groupId, groupName);
    } catch (err) { alert('åŠ å…¥å¤±è´¥ï¼š' + err.message); }
  }

  // åŠ¨æ€åŠ è½½ç¾¤ç»„å¹¶æ¸²æŸ“
  async function loadGroups() {
    const container = document.getElementById('groupsList');
    if (!container) return;
    container.innerHTML = '';
    try {
      const snap = await get(ref(db, 'groups'));
      const groups = snap.val() || {};
      for (const gid in groups) {
        const g = groups[gid] || {};
        const div = document.createElement('div');
        div.className = 'group-item';
        div.style.display = 'flex';
        div.style.alignItems = 'center';
        div.style.justifyContent = 'space-between';
        div.style.padding = '6px 0';
        div.dataset.id = gid;

        const nameSpan = document.createElement('span');
        nameSpan.textContent = g.name || ('ç¾¤ç»„ ' + gid);

        const btn = document.createElement('button');
        btn.className = 'join-group-btn unified-btn';
        btn.dataset.id = gid;
        btn.style.width = '28px';
        btn.style.height = '28px';
        btn.style.borderRadius = '50%';
        btn.style.border = 'none';
        btn.style.cursor = 'pointer';
        btn.style.fontSize = '16px';

        const members = g.members || [];
        const actionsWrap = document.createElement('div');
        actionsWrap.style.display = 'flex';
        actionsWrap.style.gap = '6px';

        if (members.includes(currentUser.uid)) {
          // å·²åŠ å…¥ï¼šæ˜¾ç¤ºèŠå¤©å…¥å£ï¼ˆç‚¹å‡»ç¾¤åï¼‰ï¼Œæ˜¾ç¤ºé€€å‡ºæŒ‰é’®ï¼Œè‹¥ä¸ºåˆ›å»ºè€…æ˜¾ç¤ºç®¡ç†æŒ‰é’®
          btn.textContent = 'èŠå¤©';
          btn.style.background = 'rgba(59,130,246,0.95)';
          btn.style.color = '#fff';
          btn.style.padding = '4px 8px';
          btn.disabled = false;
          // ç‚¹å‡»æŒ‰é’®ä¹Ÿè¿›å…¥ç¾¤èŠ
          btn.addEventListener('click', () => openGroupChat(gid, g.name || ('ç¾¤ç»„ ' + gid)));

          const leaveBtn = document.createElement('button');
          leaveBtn.className = 'unified-btn';
          leaveBtn.textContent = 'é€€å‡º';
          leaveBtn.style.padding = '4px 8px';
          leaveBtn.addEventListener('click', (ev) => { ev.stopPropagation(); leaveGroup(gid); });

          actionsWrap.appendChild(btn);
          actionsWrap.appendChild(leaveBtn);

          if (g.createdBy === currentUser.uid) {
            const manageBtn = document.createElement('button');
            manageBtn.className = 'unified-btn';
            manageBtn.textContent = 'ç®¡ç†';
            manageBtn.style.padding = '4px 8px';
            manageBtn.addEventListener('click', (ev) => { ev.stopPropagation(); manageGroup(gid); });
            actionsWrap.appendChild(manageBtn);
          }
        } else {
          btn.textContent = '+';
          btn.title = 'åŠ å…¥ç¾¤èŠ';
          btn.style.width = '28px';
          btn.style.height = '28px';
          btn.style.borderRadius = '50%';
          btn.style.padding = '0';
          btn.style.background = 'rgba(57,99,235,0.95)';
          btn.style.color = '#fff';
          actionsWrap.appendChild(btn);
        }

        // ç‚¹å‡»ç¾¤åæ‰“å¼€ç¾¤èŠ
        nameSpan.style.cursor = 'pointer';
        nameSpan.addEventListener('click', () => openGroupChat(gid, g.name || ('ç¾¤ç»„ ' + gid)));

        div.appendChild(nameSpan);
        div.appendChild(actionsWrap);
        container.appendChild(div);
      }
    } catch (err) {
      console.warn('åŠ è½½ç¾¤ç»„å¤±è´¥', err);
    }
  }

  // åˆ›å»ºæ–°ç¾¤ç»„
  document.addEventListener('click', (e) => {
    if (e.target && e.target.id === 'createGroupBtn') {
      createGroup();
    }
  });

  async function createGroup() {
    if (!currentUser || currentUser.isAnonymous) { alert('è¯·å…ˆç™»å½•'); return; }
    const name = prompt('è¯·è¾“å…¥æ–°ç¾¤ç»„åç§°ï¼š');
    if (!name) return;
    try {
      const newRef = push(ref(db, 'groups'));
      await set(newRef, { name, createdBy: currentUser.uid, members: [currentUser.uid], createdAt: Date.now() });
      await loadGroups();
      alert('ç¾¤ç»„å·²åˆ›å»º');
    } catch (err) {
      alert('åˆ›å»ºå¤±è´¥ï¼š' + err.message);
    }
  }

  // æ‰“å¼€ç¾¤èŠ
  function openGroupChat(gid, groupName) {
    currentChatId = 'group_' + gid;
    chatTitle.textContent = `${groupName} ï¼ˆç¾¤:${gid}ï¼‰`;
    chatInfo.textContent = 'ç¾¤èŠ';
    messagesArea.innerHTML = '';
    displayedMsgKeys.clear();

    const messagesRef = ref(db, `chats/group_${gid}/messages`);
    get(messagesRef).then(snapshot => {
      if (snapshot.exists()) {
        const data = snapshot.val();
        const sorted = Object.entries(data)
          .map(([key, val]) => ({ key, ...val }))
          .sort((a, b) => (a.time || 0) - (b.time || 0));
        sorted.forEach(msg => { appendMessage(msg, msg.key); displayedMsgKeys.add(msg.key); });
      }
      onChildAdded(ref(db, `chats/group_${gid}/messages`), (snapshot) => {
        const key = snapshot.key;
        if (!displayedMsgKeys.has(key)) {
          displayedMsgKeys.add(key);
          const msg = snapshot.val();
          appendMessage(msg, key);
        }
      });
    });
  }

  // é€€å‡ºç¾¤
  async function leaveGroup(gid) {
    if (!confirm('ç¡®å®šé€€å‡ºè¯¥ç¾¤å—ï¼Ÿ')) return;
    try {
      const membersRef = ref(db, `groups/${gid}/members`);
      const snap = await get(membersRef);
      const members = snap.val() || [];
      const idx = members.indexOf(currentUser.uid);
      if (idx !== -1) members.splice(idx, 1);
      await update(ref(db, `groups/${gid}`), { members });

      const myGroupsRef = ref(db, `users/${currentUser.uid}/groups`);
      const mySnap = await get(myGroupsRef);
      const myGroups = mySnap.val() || [];
      const idx2 = myGroups.indexOf(gid);
      if (idx2 !== -1) myGroups.splice(idx2, 1);
      await update(ref(db, `users/${currentUser.uid}`), { groups: myGroups });

      await loadGroups();
      // è‹¥å½“å‰æ­£åœ¨è¯¥ç¾¤èŠå¤©åˆ™åˆ‡å›å…¨å±€
      if (currentChatId === 'group_' + gid) loadGlobalChat();
      alert('å·²é€€å‡ºç¾¤');
    } catch (err) { alert('é€€å‡ºå¤±è´¥ï¼š' + err.message); }
  }

  // ç®¡ç†ç¾¤æˆå‘˜ï¼ˆç¾¤ä¸»æƒé™ï¼‰
  async function manageGroup(gid) {
    try {
      const gSnap = await get(ref(db, `groups/${gid}`));
      const g = gSnap.val() || {};
      if (g.createdBy !== currentUser.uid) { alert('åªæœ‰ç¾¤ä¸»å¯ä»¥ç®¡ç†æˆå‘˜'); return; }
      const members = g.members || [];
      // æ‹‰å–æˆå‘˜ç”¨æˆ·å
      const names = await Promise.all(members.map(async (mid) => {
        const s = await get(ref(db, `users/${mid}`));
        return s.exists() ? s.val().username : mid;
      }));
      const list = members.map((m, i) => `${i+1}. ${names[i]} (${m})`).join('\n');
      const action = prompt(`æˆå‘˜åˆ—è¡¨ï¼š\n${list}\n\nè¾“å…¥ 'remove:UID' åˆ é™¤æˆå‘˜ï¼Œæˆ– 'add:username' æ·»åŠ æˆå‘˜ï¼Œç•™ç©ºå–æ¶ˆ`);
      if (!action) return;
      if (action.startsWith('remove:')) {
        const uid = action.split(':')[1].trim();
        const idx = members.indexOf(uid);
        if (idx === -1) return alert('æˆå‘˜ä¸å­˜åœ¨');
        members.splice(idx, 1);
        await update(ref(db, `groups/${gid}`), { members });
        alert('å·²ç§»é™¤æˆå‘˜');
      } else if (action.startsWith('add:')) {
        const uname = action.split(':')[1].trim();
        if (!uname) return;
        // æ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾ uid
        const usersSnap = await get(ref(db, 'users'));
        const users = usersSnap.val() || {};
        let found = null;
        for (const uid in users) { if (users[uid].username === uname) { found = uid; break; } }
        if (!found) return alert('ç”¨æˆ·ä¸å­˜åœ¨');
        if (!members.includes(found)) members.push(found);
        await update(ref(db, `groups/${gid}`), { members });
        // åŒæ­¥ç”¨æˆ·çš„ groups åˆ—è¡¨
        const myGroupsRef = ref(db, `users/${found}/groups`);
        const mg = (await get(myGroupsRef)).val() || [];
        if (!mg.includes(gid)) mg.push(gid);
        await update(ref(db, `users/${found}`), { groups: mg });
        alert('å·²æ·»åŠ æˆå‘˜');
      }
      await loadGroups();
    } catch (err) { alert('ç®¡ç†å¤±è´¥ï¼š' + err.message); }
  }

  function openChat(friendId, friendName) {
    const chatId = [currentUser.uid, friendId].sort().join('_');
    currentChatId = chatId;
    chatTitle.textContent = friendName;
    chatInfo.textContent = 'ç§èŠ';

    messagesArea.innerHTML = '';
    displayedMsgKeys.clear();
    
    // å…ˆåŠ è½½å†å²æ¶ˆæ¯
    const messagesRef = ref(db, `chats/${chatId}/messages`);
    get(messagesRef).then(snapshot => {
      if (snapshot.exists()) {
        const data = snapshot.val();
        const sorted = Object.entries(data)
          .map(([key, val]) => ({ key, ...val }))
          .sort((a, b) => (a.time || 0) - (b.time || 0));
        
        sorted.forEach(msg => {
          appendMessage(msg, msg.key);
          displayedMsgKeys.add(msg.key);
        });
      }
      
      // ç›‘å¬æ–°æ¶ˆæ¯
      onChildAdded(ref(db, `chats/${chatId}/messages`), (snapshot) => {
        const key = snapshot.key;
        if (!displayedMsgKeys.has(key)) {
          displayedMsgKeys.add(key);
          const msg = snapshot.val();
          appendMessage(msg, key);
        }
      });
      // å¦‚æœæ˜¯ç§»åŠ¨ç«¯ï¼Œé€‰æ‹©å¥½å‹åè‡ªåŠ¨å…³é—­ä¾§è¾¹æ æŠ½å±‰
      if (window.innerWidth <= 640) {
        const sidebar = document.querySelector('.left-sidebar');
        if (sidebar && sidebar.classList.contains('mobile-show')) sidebar.classList.remove('mobile-show');
      }
    });
  }

  addFriendBtn.addEventListener('click', () => {
    const friendUsername = prompt('è¾“å…¥å¥½å‹ç”¨æˆ·åï¼š');
    if (!friendUsername) return;

    get(ref(db, 'users')).then(snapshot => {
      const users = snapshot.val() || {};
      let friendId = null;

      for (const uid in users) {
        if (users[uid].username === friendUsername) {
          friendId = uid;
          break;
        }
      }

      if (!friendId) {
        alert('ç”¨æˆ·ä¸å­˜åœ¨');
        return;
      }

      if (friendId === currentUser.uid) {
        alert('ä¸èƒ½æ·»åŠ è‡ªå·±');
        return;
      }

      // æ£€æŸ¥æ˜¯å¦å·²æ˜¯å¥½å‹
      get(ref(db, `users/${currentUser.uid}`)).then(snapshot => {
        const userData = snapshot.val();
        const friends = userData?.friends || [];

        if (friends.includes(friendId)) {
          alert('å·²æ˜¯å¥½å‹');
          return;
        }

        // å‘é€å¥½å‹ç”³è¯·
        const requests = userData?.friendRequests || [];
        if (requests.includes(friendId)) {
          alert('å·²å‘é€ç”³è¯·ï¼Œè¯·ç­‰å¾…å¯¹æ–¹åŒæ„');
          return;
        }

        requests.push(friendId);
        update(ref(db, `users/${currentUser.uid}`), { friendRequests: requests });

        // åŒæ—¶åœ¨å¯¹æ–¹çš„å¾…æ”¶åˆ—è¡¨ä¸­æ·»åŠ 
        get(ref(db, `users/${friendId}`)).then(friendSnapshot => {
          const friendData = friendSnapshot.val();
          const pendingRequests = friendData?.pendingFriendRequests || [];
          if (!pendingRequests.includes(currentUser.uid)) {
            pendingRequests.push(currentUser.uid);
            update(ref(db, `users/${friendId}`), { pendingFriendRequests: pendingRequests });
          }
        });

        alert('ç”³è¯·å·²å‘é€ï¼');
      });
    });
  });

  // === åŠ è½½å¾…æ”¶çš„å¥½å‹ç”³è¯· ===
  function loadPendingRequests() {
    if (currentUser.isAnonymous) return;

    const userRef = ref(db, `users/${currentUser.uid}`);
    get(userRef).then(snapshot => {
      const userData = snapshot.val();
      const pending = userData?.pendingFriendRequests || [];

      if (pending.length === 0) return;

      // åˆ›å»ºä¸€ä¸ªå¾…å®¡æ‰¹åˆ—è¡¨å®¹å™¨ï¼ˆå¯é€‰ï¼‰
      pending.forEach(requesterId => {
        get(ref(db, `users/${requesterId}`)).then(requesterSnapshot => {
          if (!requesterSnapshot.exists()) return;
          const requester = requesterSnapshot.val();

          // å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
          const accept = confirm(`${requester.username} æƒ³æ·»åŠ ä½ ä¸ºå¥½å‹ï¼Œæ˜¯å¦åŒæ„ï¼Ÿ`);
          
          if (accept) {
            // åŒæ„ï¼šåŒæ–¹éƒ½åŠ å…¥å¥½å‹åˆ—è¡¨
            get(ref(db, `users/${currentUser.uid}`)).then(mySnapshot => {
              const myData = mySnapshot.val();
              const myFriends = myData?.friends || [];
              const myPending = myData?.pendingFriendRequests || [];

              if (!myFriends.includes(requesterId)) {
                myFriends.push(requesterId);
              }
              myPending.splice(myPending.indexOf(requesterId), 1);

              update(ref(db, `users/${currentUser.uid}`), {
                friends: myFriends,
                pendingFriendRequests: myPending
              });
            });

            // æ›´æ–°å¯¹æ–¹
            get(ref(db, `users/${requesterId}`)).then(requesterSnapshot2 => {
              const requesterData = requesterSnapshot2.val();
              const requesterFriends = requesterData?.friends || [];
              const requesterSent = requesterData?.friendRequests || [];

              if (!requesterFriends.includes(currentUser.uid)) {
                requesterFriends.push(currentUser.uid);
              }
              requesterSent.splice(requesterSent.indexOf(currentUser.uid), 1);

              update(ref(db, `users/${requesterId}`), {
                friends: requesterFriends,
                friendRequests: requesterSent
              });
            });

            loadFriends();
          } else {
            // æ‹’ç»
            get(ref(db, `users/${currentUser.uid}`)).then(mySnapshot => {
              const myData = mySnapshot.val();
              const myPending = myData?.pendingFriendRequests || [];
              myPending.splice(myPending.indexOf(requesterId), 1);
              update(ref(db, `users/${currentUser.uid}`), { pendingFriendRequests: myPending });
            });

            get(ref(db, `users/${requesterId}`)).then(requesterSnapshot2 => {
              const requesterData = requesterSnapshot2.val();
              const requesterSent = requesterData?.friendRequests || [];
              requesterSent.splice(requesterSent.indexOf(currentUser.uid), 1);
              update(ref(db, `users/${requesterId}`), { friendRequests: requesterSent });
            });
          }
        });
      });
    });
  }

  // === å¤´åƒç®¡ç† ===
  userAvatar.addEventListener('click', () => {
    avatarUpload.click();
  });

  avatarUpload.addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    if (!file || currentUser.isAnonymous) return;

    // é™åˆ¶æ–‡ä»¶å¤§å°ï¼ˆæœ€å¤§ 500KBï¼‰
    if (file.size > 500 * 1024) {
      alert('å¤´åƒæ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº 500KB çš„å›¾ç‰‡');
      return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      const dataUrl = reader.result;
      avatarText.textContent = ''; // éšè—æ–‡å­—ï¼Œæ˜¾ç¤ºå›¾ç‰‡
      userAvatar.style.backgroundImage = `url(${dataUrl})`;
      userAvatar.style.backgroundSize = 'cover';

      // æ›´æ–°åˆ°æ•°æ®åº“
      update(ref(db, `users/${currentUser.uid}`), { avatar: dataUrl });
      currentUser.avatar = dataUrl;
      
      // æ›´æ–°æœ¬åœ°å­˜å‚¨
      localStorage.setItem('pexgram_user', JSON.stringify(currentUser));
    };
    reader.readAsDataURL(file);
  });

  // === ç™»å‡º ===
  logoutBtn.addEventListener('click', () => {
    if (confirm('ç¡®å®šè¦ç™»å‡ºå—ï¼Ÿ')) {
      currentUser = null;
      localStorage.removeItem('pexgram_user');
      authPanel.classList.remove('hidden');
      chatPanel.classList.remove('active');
      document.getElementById('loginUsername').value = '';
      document.getElementById('loginPassword').value = '';
      messagesArea.innerHTML = '';
    }
  });

  // === è”ç³»æ–¹å¼èœå• ===
  contactBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    contactMenu.classList.toggle('show');
  });

  document.addEventListener('click', (e) => {
    if (!e.target.closest('#contactBtn') && !e.target.closest('#contactMenu')) {
      contactMenu.classList.remove('show');
    }
  });

  // === å›¾ç‰‡æ”¾å¤§ ===
  const imageModal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');

  function attachImageClickListener(img) {
    img.addEventListener('click', (e) => {
      e.stopPropagation();
      modalImage.src = img.src;
      imageModal.classList.add('show');
    });
  }

  imageModal.addEventListener('click', () => {
    imageModal.classList.remove('show');
  });

  // === æœ‹å‹åœˆï¼ˆMomentsï¼‰ ===
  const momentsModal = document.getElementById('momentsModal');
  const momentsBtnEl = document.getElementById('momentsBtn');
  const postMomentBtn = document.getElementById('postMomentBtn');
  const momentText = document.getElementById('momentText');
  const momentsList = document.getElementById('momentsList');

  momentsBtnEl.addEventListener('click', (e) => {
    e.stopPropagation();
    momentsModal.classList.toggle('show');
    if (momentsModal.classList.contains('show')) loadMoments();
  });

  // å…³é—­æŒ‰é’®å’ŒèƒŒæ™¯ç‚¹å‡»è¡Œä¸º for moments
  const closeMomentsBtn = document.getElementById('closeMomentsBtn');
  const momentsContent = document.getElementById('momentsContent');
  closeMomentsBtn.addEventListener('click', () => momentsModal.classList.remove('show'));
  momentsModal.addEventListener('click', () => momentsModal.classList.remove('show'));
  momentsContent.addEventListener('click', (e) => e.stopPropagation());

  postMomentBtn.addEventListener('click', async () => {
    const text = momentText.value.trim();
    if (!text) return alert('è¯·è¾“å…¥å†…å®¹');
    try {
      await push(ref(db, 'moments'), {
        uid: currentUser.uid,
        username: currentUser.username,
        text,
        time: Date.now(),
        likes: []
      });
      momentText.value = '';
      // å‘å¸ƒåè‡ªåŠ¨åˆ·æ–°å¹¶å…³é—­å¼¹çª—
      await loadMoments();
      momentsModal.classList.remove('show');
    } catch (err) {
      alert('å‘å¸ƒå¤±è´¥ï¼š' + err.message);
    }
  });

  async function loadMoments() {
    momentsList.innerHTML = '';
    const snap = await get(ref(db, 'moments'));
    const data = snap.val() || {};
    const items = Object.entries(data).map(([k, v]) => ({ id: k, ...v }))
      .sort((a, b) => b.time - a.time);
    items.forEach(item => {
      const div = document.createElement('div');
      div.style.borderBottom = '1px solid rgba(255,255,255,0.04)';
      div.style.padding = '8px 0';
      div.innerHTML = `<div style="font-weight:600">${item.username}</div><div style="font-size:13px; margin:6px 0">${item.text}</div>`;
      const likeBtn = document.createElement('button');
      likeBtn.textContent = `ğŸ‘ ${item.likes ? item.likes.length : 0}`;
      likeBtn.style.fontSize = '12px';
      likeBtn.addEventListener('click', async () => {
        const likesRef = ref(db, `moments/${item.id}/likes`);
        const snap2 = await get(likesRef);
        const arr = snap2.val() || [];
        const idx = arr.indexOf(currentUser.uid);
        if (idx === -1) arr.push(currentUser.uid);
        else arr.splice(idx, 1);
        await update(ref(db, `moments/${item.id}`), { likes: arr });
        loadMoments();
      });
      div.appendChild(likeBtn);
      momentsList.appendChild(div);
    });
  }

  // === è¡¨æƒ…åŒ…åŠŸèƒ½ ===
  const emojis = ['ğŸ˜Š', 'ğŸ˜‚', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤”', 'ğŸ˜´', 'ğŸ˜¤', 'ğŸ˜¡', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ¤©',
    'ğŸ™ƒ', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ˜’', 'ğŸ¥±', 'ğŸ˜²', 'ğŸ¤¨', 'ğŸ˜•', 'ğŸ« ', 'ğŸ˜³', 'ğŸ¥º', 'ğŸ˜±',
    'ğŸ‘', 'ğŸ‘', 'â¤ï¸', 'ğŸ”¥', 'âœ¨', 'ğŸ‰', 'ğŸŠ', 'ğŸ’¯', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤', 'ğŸ’ª',
    'ğŸ±', 'ğŸ¶', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®'];

  function initEmojiPicker() {
    emojis.forEach(emoji => {
      const btn = document.createElement('div');
      btn.className = 'emoji-item';
      btn.textContent = emoji;
      btn.addEventListener('click', () => {
        msgInput.value += emoji;
        emojiPicker.classList.remove('show');
      });
      emojiPicker.appendChild(btn);
    });
  }

  emojiBtn.addEventListener('click', () => {
    emojiPicker.classList.toggle('show');
  });

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.input-toolbar')) {
      emojiPicker.classList.remove('show');
    }
  });

  // === æ”¹è¿›çš„è¯­éŸ³å½•åˆ¶ ===
  recordBtn.addEventListener('click', async () => {
    if (isRecording) {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
      }
      recordBtn.classList.remove('recording');
      recordBtn.textContent = 'ğŸ¤';
      isRecording = false;
      return;
    }

    try {
      // åœæ­¢ä»»ä½•æ­£åœ¨è¿›è¡Œçš„æµ
      if (mediaStream) {
        mediaStream.getTracks().forEach(t => t.stop());
      }

      // è¯·æ±‚éº¦å…‹é£æƒé™
      mediaStream = await navigator.mediaDevices.getUserMedia({
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: true
        }
      });

      recordingChunks = [];
      
      // å°è¯•ä¸åŒçš„ MIME ç±»å‹
      const mimeTypes = ['audio/webm', 'audio/mp4', 'audio/wav', 'audio/ogg'];
      let selectedMimeType = 'audio/webm';
      
      for (const mimeType of mimeTypes) {
        if (MediaRecorder.isTypeSupported(mimeType)) {
          selectedMimeType = mimeType;
          break;
        }
      }

      mediaRecorder = new MediaRecorder(mediaStream, { mimeType: selectedMimeType });

      mediaRecorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) {
          recordingChunks.push(e.data);
        }
      };

      mediaRecorder.onstop = () => {
        const mimeType = mediaRecorder.mimeType || 'audio/webm';
        const blob = new Blob(recordingChunks, { type: mimeType });
        
        if (blob.size === 0) {
          alert('å½•éŸ³å¤±è´¥ï¼Œè¯·é‡è¯•');
          return;
        }

        const reader = new FileReader();
        reader.onload = () => {
          push(ref(db, `chats/${currentChatId}/messages`), {
            uid: currentUser.uid,
            username: currentUser.username,
            type: 'audio',
            data: reader.result,
            time: Date.now()
          });
        };
        reader.onerror = () => {
          alert('å½•éŸ³è½¬æ¢å¤±è´¥');
        };
        reader.readAsDataURL(blob);
      };

      mediaRecorder.onerror = (e) => {
        alert('å½•éŸ³é”™è¯¯ï¼š' + e.error);
        isRecording = false;
        recordBtn.classList.remove('recording');
        recordBtn.textContent = 'ğŸ¤';
      };

      mediaRecorder.start();
      recordBtn.classList.add('recording');
      recordBtn.textContent = 'â—';
      isRecording = true;
    } catch (err) {
      let errMsg = 'æ— æ³•è®¿é—®éº¦å…‹é£';
      if (err.name === 'NotAllowedError') {
        errMsg = 'è¯·å…è®¸è®¿é—®éº¦å…‹é£æƒé™';
      } else if (err.name === 'NotFoundError') {
        errMsg = 'æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡';
      }
      alert(errMsg + 'ï¼š' + err.message);
      isRecording = false;
    }
  });

  // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
  window.addEventListener('beforeunload', () => {
    if (mediaStream) {
      mediaStream.getTracks().forEach(t => t.stop());
    }
  });

  // æŒ‰ Esc å…³é—­æ¨¡æ€çª—å£
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const modals = [document.getElementById('imageModal'), document.getElementById('momentsModal'), document.getElementById('favoritesModal')];
      modals.forEach(m => { if (m && m.classList.contains('show')) m.classList.remove('show'); });
    }
  });

  // åˆå§‹åŒ–è¡¨æƒ…é€‰æ‹©å™¨
  // === å¥½å‹è¯·æ±‚ï¼ˆUIï¼‰ä¸è®¾ç½® ===
  const pendingRequestsDiv = document.getElementById('pendingRequests');
  const settingsBtnEl = document.getElementById('settingsBtn');
  const settingsModalEl = document.getElementById('settingsModal');
  const closeSettingsBtn = document.getElementById('closeSettingsBtn');
  const settingNotifyCheckbox = document.getElementById('settingNotifyCheckbox');
  const saveSettingsBtnEl = document.getElementById('saveSettingsBtn');
  const deleteAccountBtnEl = document.getElementById('deleteAccountBtn');
  const settingsHintEl = document.getElementById('settingsHint');

  async function loadPendingRequestsUI() {
    if (!currentUser || currentUser.isAnonymous) return;
    pendingRequestsDiv.innerHTML = '';
    const userSnap = await get(ref(db, `users/${currentUser.uid}`));
    const userData = userSnap.val() || {};
    const pending = userData.pendingFriendRequests || [];
    if (!pending || pending.length === 0) {
      pendingRequestsDiv.innerHTML = '<div style="padding:6px;color:var(--muted);">æš‚æ— å¥½å‹è¯·æ±‚</div>';
      return;
    }

    pending.forEach(requesterId => {
      get(ref(db, `users/${requesterId}`)).then(reqSnap => {
        if (!reqSnap.exists()) return;
        const requester = reqSnap.val();
        const item = document.createElement('div');
        item.style.display = 'flex';
        item.style.alignItems = 'center';
        item.style.justifyContent = 'space-between';
        item.style.padding = '6px 0';

        const left = document.createElement('div');
        left.style.display = 'flex';
        left.style.alignItems = 'center';
        left.style.gap = '8px';
        const av = document.createElement('div');
        av.style.width = '28px';
        av.style.height = '28px';
        av.style.borderRadius = '6px';
        av.style.background = 'linear-gradient(135deg,#7b61ff,#39d7ff)';
        av.style.display = 'flex';
        av.style.alignItems = 'center';
        av.style.justifyContent = 'center';
        av.textContent = requester.avatar && !requester.avatar.startsWith('data:') ? requester.avatar : 'ğŸ‘¤';
        left.appendChild(av);
        const name = document.createElement('div');
        name.textContent = requester.username || requesterId;
        left.appendChild(name);

        const actions = document.createElement('div');
        const accept = document.createElement('button');
        accept.textContent = 'åŒæ„';
        accept.style.marginRight = '6px';
        accept.addEventListener('click', () => acceptPendingRequest(requesterId));
        const reject = document.createElement('button');
        reject.textContent = 'æ‹’ç»';
        reject.addEventListener('click', () => rejectPendingRequest(requesterId));
        actions.appendChild(accept);
        actions.appendChild(reject);

        item.appendChild(left);
        item.appendChild(actions);
        pendingRequestsDiv.appendChild(item);
      });
    });
  }

  async function acceptPendingRequest(requesterId) {
    if (!confirm('åŒæ„è¯¥å¥½å‹ç”³è¯·ï¼Ÿ')) return;
    // æ›´æ–°æˆ‘è¿™è¾¹
    const myRef = ref(db, `users/${currentUser.uid}`);
    const mySnap = await get(myRef);
    const myData = mySnap.val() || {};
    const myFriends = myData.friends || [];
    const myPending = myData.pendingFriendRequests || [];
    if (!myFriends.includes(requesterId)) myFriends.push(requesterId);
    const pIdx = myPending.indexOf(requesterId);
    if (pIdx !== -1) myPending.splice(pIdx, 1);
    await update(myRef, { friends: myFriends, pendingFriendRequests: myPending });

    // æ›´æ–°å¯¹æ–¹
    const reqRef = ref(db, `users/${requesterId}`);
    const reqSnap = await get(reqRef);
    const reqData = reqSnap.val() || {};
    const reqFriends = reqData.friends || [];
    const reqSent = reqData.friendRequests || [];
    if (!reqFriends.includes(currentUser.uid)) reqFriends.push(currentUser.uid);
    const sIdx = reqSent.indexOf(currentUser.uid);
    if (sIdx !== -1) reqSent.splice(sIdx, 1);
    await update(reqRef, { friends: reqFriends, friendRequests: reqSent });

    loadFriends();
    loadPendingRequestsUI();
    alert('å·²åŒæ„');
  }

  async function rejectPendingRequest(requesterId) {
    if (!confirm('æ‹’ç»è¯¥å¥½å‹ç”³è¯·ï¼Ÿ')) return;
    const myRef = ref(db, `users/${currentUser.uid}`);
    const mySnap = await get(myRef);
    const myData = mySnap.val() || {};
    const myPending = myData.pendingFriendRequests || [];
    const pIdx = myPending.indexOf(requesterId);
    if (pIdx !== -1) myPending.splice(pIdx, 1);
    await update(myRef, { pendingFriendRequests: myPending });

    const reqRef = ref(db, `users/${requesterId}`);
    const reqSnap = await get(reqRef);
    const reqData = reqSnap.val() || {};
    const reqSent = reqData.friendRequests || [];
    const sIdx = reqSent.indexOf(currentUser.uid);
    if (sIdx !== -1) reqSent.splice(sIdx, 1);
    await update(reqRef, { friendRequests: reqSent });

    loadPendingRequestsUI();
    alert('å·²æ‹’ç»');
  }

  // è®¾ç½®ç›¸å…³
  settingsBtnEl.addEventListener('click', (e) => {
    e.stopPropagation();
    if (!currentUser) return;
    loadUserSettings();
    settingsModalEl.classList.toggle('show');
  });
  closeSettingsBtn.addEventListener('click', () => settingsModalEl.classList.remove('show'));
  settingsModalEl.addEventListener('click', () => settingsModalEl.classList.remove('show'));
  settingsModalEl.querySelector('div').addEventListener('click', (e) => e.stopPropagation());

  async function loadUserSettings() {
    if (!currentUser) return;
    const s = await get(ref(db, `users/${currentUser.uid}/settings`));
    const obj = s.val() || {};
    settingNotifyCheckbox.checked = !!obj.notify;
    settingsHintEl.textContent = '';
  }

  saveSettingsBtnEl.addEventListener('click', async () => {
    if (!currentUser) return;
    const settingsObj = { notify: !!settingNotifyCheckbox.checked };
    await update(ref(db, `users/${currentUser.uid}`), { settings: settingsObj });
    settingsHintEl.textContent = 'å·²ä¿å­˜';
    setTimeout(() => settingsHintEl.textContent = '', 1200);
  });

  deleteAccountBtnEl.addEventListener('click', async () => {
    if (!currentUser) return;
    if (!confirm('ç¡®å®šè¦åˆ é™¤è´¦å·å¹¶æ¸…é™¤ç›¸å…³æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
    const uid = currentUser.uid;
    // ä»å…¶ä»–ç”¨æˆ·ä¸­ç§»é™¤è¯¥ uid
    const allUsersSnap = await get(ref(db, 'users'));
    const allUsers = allUsersSnap.val() || {};
    for (const otherId in allUsers) {
      if (otherId === uid) continue;
      const other = allUsers[otherId] || {};
      let changed = false;
      const f = other.friends || [];
      const fi = f.indexOf(uid);
      if (fi !== -1) { f.splice(fi, 1); changed = true; }
      const p = other.pendingFriendRequests || [];
      const pi = p.indexOf(uid);
      if (pi !== -1) { p.splice(pi, 1); changed = true; }
      const fr = other.friendRequests || [];
      const fri = fr.indexOf(uid);
      if (fri !== -1) { fr.splice(fri, 1); changed = true; }
      if (changed) {
        await update(ref(db, `users/${otherId}`), { friends: f, pendingFriendRequests: p, friendRequests: fr });
      }
    }
    // åˆ é™¤ç”¨æˆ·è®°å½•
    await set(ref(db, `users/${uid}`), null);
    // æ¸…ç†æœ¬åœ°çŠ¶æ€å¹¶ç™»å‡º
    currentUser = null;
    localStorage.removeItem('pexgram_user');
    authPanel.classList.remove('hidden');
    chatPanel.classList.remove('active');
    messagesArea.innerHTML = '';
    alert('è´¦å·å·²åˆ é™¤');
  });

  initEmojiPicker();

  // === æ¡Œé¢é€šçŸ¥æ”¯æŒ ===
  async function ensureNotification() {
    if (!('Notification' in window)) return false;
    if (Notification.permission === 'granted') return true;
    if (Notification.permission !== 'denied') {
      const p = await Notification.requestPermission();
      return p === 'granted';
    }
    return false;
  }

  function showNotification(title, body) {
    try {
      ensureNotification().then(ok => {
        if (ok) {
          new Notification(title, { body });
        }
      });
    } catch (e) { console.warn('notification error', e); }
  }

  // === æ¯›ç»ç’ƒæ–‡ä»¶å‘é€é¢æ¿é€»è¾‘ ===
  const filePanel = document.getElementById('filePanel');
  const filePanelInput = document.getElementById('filePanelInput');
  const filePanelList = document.getElementById('filePanelList');
  const filePanelSend = document.getElementById('filePanelSend');
  let stagedFiles = [];

  // åˆ‡æ¢é¢æ¿ï¼šå°†åŸä¸Šä¼ æ–‡ä»¶æŒ‰é’®æ”¹ä¸ºæ‰“å¼€é¢æ¿
  uploadFileBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    filePanel.style.display = filePanel.style.display === 'none' ? 'block' : 'none';
  });

  filePanelInput.addEventListener('change', (e) => {
    handlePanelFiles(e.target.files);
  });

  filePanel.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; });
  filePanel.addEventListener('drop', (e) => { e.preventDefault(); handlePanelFiles(e.dataTransfer.files); });

  function handlePanelFiles(list) {
    for (const f of list) stagedFiles.push(f);
    renderStagedFiles();
  }

  function renderStagedFiles() {
    filePanelList.innerHTML = '';
    stagedFiles.forEach((f, i) => {
      const it = document.createElement('div'); it.className = 'file-item';
      if (f.type.startsWith('image/')) { const img = document.createElement('img'); img.src = URL.createObjectURL(f); it.appendChild(img); }
      const meta = document.createElement('div'); meta.style.flex = '1'; meta.innerHTML = `<div style="font-weight:700">${f.name}</div><div style="font-size:12px;opacity:0.75">${Math.round(f.size/1024)} KB</div>`;
      it.appendChild(meta);
      const actions = document.createElement('div'); actions.className = 'file-actions';
      const rem = document.createElement('button'); rem.textContent = 'ç§»é™¤'; rem.className = 'auth-btn'; rem.style.background = '#ef4444'; rem.onclick = () => { stagedFiles.splice(i, 1); renderStagedFiles(); };
      actions.appendChild(rem);
      it.appendChild(actions);
      filePanelList.appendChild(it);
    });
  }

  filePanelSend.addEventListener('click', async () => {
    if (!stagedFiles.length) { alert('è¯·é€‰æ‹©æ–‡ä»¶'); return; }
    for (const f of stagedFiles) {
      const reader = new FileReader();
      reader.onload = () => {
        push(ref(db, `chats/${currentChatId}/messages`), {
          uid: currentUser.uid,
          username: currentUser.username,
          type: 'file',
          fileUrl: reader.result,
          fileName: f.name,
          time: Date.now()
        });
      };
      reader.readAsDataURL(f);
    }
    stagedFiles = []; renderStagedFiles(); filePanel.style.display = 'none';
  });

  // === é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å·²ä¿å­˜çš„ç™»å½•çŠ¶æ€ ===
  window.addEventListener('load', () => {
    const savedUser = localStorage.getItem('pexgram_user');
    if (savedUser) {
      try {
        currentUser = JSON.parse(savedUser);
        enterChat();
      } catch (err) {
        console.error('æ¢å¤ç™»å½•çŠ¶æ€å¤±è´¥:', err);
        localStorage.removeItem('pexgram_user');
      }
    }
  });
</script>

</body>
</html>
