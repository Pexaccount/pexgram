<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>PexåŒ¿åå…¨çƒèŠå¤©å®¤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --glass-bg: rgba(255,255,255,0.06);
      --glass-strong: rgba(255,255,255,0.10);
      --accent: linear-gradient(135deg,#7b61ff 0%,#39d7ff 100%);
      --text: rgba(255,255,255,0.95);
      --muted: rgba(255,255,255,0.75);
    }

    html,body{ height:100%; }
    body {
      margin:0; padding:0; font-family: Inter, 'Segoe UI', Arial;
      background: radial-gradient(ellipse at 10% 10%, #0f1724 0%, #071028 40%, #0b1220 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      display:flex; align-items:center; justify-content:center; padding:32px;
    }

    #chat{
      width:100%; max-width:880px; background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border-radius:18px; padding:20px; box-sizing:border-box;
      box-shadow: 0 8px 30px rgba(2,6,23,0.6);
      backdrop-filter: blur(10px) saturate(120%);
      -webkit-backdrop-filter: blur(10px) saturate(120%);
      border: 1px solid rgba(255,255,255,0.06);
      position:relative;
      overflow:visible;
    }

    h2{ margin:0 0 14px 0; font-weight:600; color:var(--text); display:flex; align-items:center; gap:10px;}

    #messages{
      background: transparent; height:66vh; overflow-y:auto; padding:18px 18px 140px 18px; border-radius:12px;
      display:flex; flex-direction:column; gap:12px;
    }

    .msg{ display:flex; align-items:flex-end; margin-bottom:6px; }
    .msg.me{ justify-content:flex-end; }

    .bubble{
      max-width:70%; padding:10px 14px; border-radius:12px; color:var(--text); font-size:15px; line-height:1.35;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.04);
      backdrop-filter: blur(6px);
    }

    .msg.me .bubble{
      background: linear-gradient(180deg, rgba(59,130,246,0.18), rgba(59,130,246,0.12));
      border: 1px solid rgba(59,130,246,0.25);
      color: #fff;
      border-bottom-right-radius:4px; border-bottom-left-radius:12px; border-top-left-radius:12px; border-top-right-radius:12px;
    }

    .meta{ font-size:12px; color:var(--muted); margin-bottom:6px; }
    .me .meta{ text-align:right; }

    /* å›ºå®šåœ¨èŠå¤©é¢æ¿åº•éƒ¨çš„è¾“å…¥åŒº */
    #inputBox{
      position:absolute; left:20px; right:20px; bottom:20px;
      display:flex; gap:10px; align-items:center; padding:10px; box-sizing:border-box;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:14px; border:1px solid rgba(255,255,255,0.04); z-index:30;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }

    @media (max-width:640px){
      #chat{ padding:12px; }
      #inputBox{ left:12px; right:12px; bottom:12px; }
      #messages{ height:60vh; padding-bottom:180px; }
    }

    /* small circular icon buttons for attach/record */
    .icon-btn{
      width:44px; height:44px; padding:0; display:inline-flex; align-items:center; justify-content:center;
      border-radius:999px; background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04); color:var(--text);
      box-shadow: none; font-size:18px;
    }

    .icon-btn.recording{ background: linear-gradient(90deg,#ff5656,#ff9a56); color:#fff; box-shadow: 0 6px 18px rgba(255,86,86,0.18); }

    .bubble img{ max-width:100%; height:auto; border-radius:10px; display:block; }
    .bubble audio{ width:100%; margin-top:6px; }

    /* textarea / input styles */
    .text-area-wrap{ flex:1; display:flex; flex-direction:column; gap:6px; }
    .input-label{ font-size:12px; color:var(--muted); margin-left:6px; }
    textarea#text{ width:100%; min-height:46px; max-height:140px; resize:none; padding:12px 16px; font-size:15px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.02); color:var(--text); outline:none;
      transition: box-shadow .12s ease, border-color .12s ease, transform .06s ease; line-height:1.35;
    }
    textarea#text:focus{ box-shadow: 0 8px 30px rgba(59,130,246,0.14); border-color: rgba(59,130,246,0.28); transform: translateY(-1px); }

    #text{ flex:1; padding:12px 16px; font-size:16px; border-radius:999px; border:none; outline:none;
      background: rgba(255,255,255,0.03); color:var(--text); box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
      backdrop-filter: blur(6px);
    }

    #text::placeholder{ color: rgba(255,255,255,0.5); }

    button{ padding:10px 18px; font-size:16px; cursor:pointer; border-radius:999px; border:none; color:#fff;
      background: var(--accent); box-shadow: 0 6px 18px rgba(59,130,246,0.18); transition:transform .12s ease, box-shadow .12s ease;
    }

    button:active{ transform:translateY(1px); }
    button:disabled{ opacity:0.5; transform:none; cursor:default; }

    /* Scrollbar styling */
    #messages::-webkit-scrollbar{ width:10px; }
    #messages::-webkit-scrollbar-thumb{ background: rgba(255,255,255,0.04); border-radius:10px; }
  </style>
</head>
<body>

<div id="chat">
  <h2>ğŸŒ PexåŒ¿åå…¨çƒèŠå¤©å®¤</h2>
  <div id="messages"></div>

  <div id="inputBox">
    <button id="imgBtn" class="icon-btn" title="å‘é€å›¾ç‰‡">ğŸ“·</button>
    <input id="imageInput" type="file" accept="image/*" style="display:none">

    <button id="recBtn" class="icon-btn" title="å½•éŸ³/åœæ­¢">ğŸ¤</button>

    <div class="text-area-wrap">
      <label class="input-label" for="text">æ¶ˆæ¯</label>
      <textarea id="text" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯... (Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ)" maxlength="1000"></textarea>
    </div>

    <button id="sendBtn">å‘é€</button>
  </div>
</div>

<!-- Firebase v12 æ¨¡å—åŒ– SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, serverTimestamp, limitToLast, query } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAlOYUdwcNWWueaj7X9RdzzkAk_r-_JWL8",
    authDomain: "pexchatweb.firebaseapp.com",
    databaseURL: "https://pexchatweb-default-rtdb.firebaseio.com",
    projectId: "pexchatweb",
    storageBucket: "pexchatweb.firebasestorage.app",
    messagingSenderId: "157034955766",
    appId: "1:157034955766:web:076f39819c081d73b8fdd7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const messagesRef = ref(db, 'messages');

  const username = "åŒ¿å_" + Math.floor(Math.random() * 10000);

  const sendBtn = document.getElementById("sendBtn");
  const textInput = document.getElementById("text");
  const messagesEl = document.getElementById("messages");
  const imgBtn = document.getElementById('imgBtn');
  const imageInput = document.getElementById('imageInput');
  const recBtn = document.getElementById('recBtn');

  let mediaRecorder = null;
  let recordingChunks = [];

  function createMessageElement(msg){
    const wrapper = document.createElement('div');
    wrapper.className = 'msg';
    if(msg.user === username) wrapper.classList.add('me');

    const bubble = document.createElement('div');
    bubble.className = 'bubble';

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = msg.user;
    // æ ¹æ®æ¶ˆæ¯ç±»å‹åˆ›å»ºå†…å®¹èŠ‚ç‚¹ï¼ˆtext/image/audioï¼‰
    let contentEl = null;
    if(msg.type === 'image'){
      const img = document.createElement('img');
      img.src = msg.data;
      img.alt = msg.text || 'image';
      contentEl = img;
    } else if(msg.type === 'audio'){
      const audio = document.createElement('audio');
      audio.controls = true;
      audio.src = msg.data;
      contentEl = audio;
    } else {
      const text = document.createElement('div');
      text.className = 'text';
      text.textContent = msg.text || '';
      contentEl = text;
    }

    // ç»“æ„ï¼š è‹¥ä¸ºè‡ªå·±ï¼Œæ˜¾ç¤ºæ°”æ³¡ï¼ˆé å³ï¼‰ï¼›å¦åˆ™åœ¨æ°”æ³¡ä¸Šæ–¹æ˜¾ç¤ºç”¨æˆ·å
    if(msg.user === username){
      if(contentEl) bubble.appendChild(contentEl);
      wrapper.appendChild(bubble);
    } else {
      wrapper.appendChild(meta);
      if(contentEl) bubble.appendChild(contentEl);
      wrapper.appendChild(bubble);
    }

    return wrapper;
  }

  function sendMessage(){
    const text = textInput.value.trim();
    if(!text) return;
    push(messagesRef, { user: username, text: text, time: serverTimestamp() });
    textInput.value = '';
    // reset textarea height after send
    autoResizeTextarea();
  }

  sendBtn.addEventListener('click', sendMessage);
  textInput.addEventListener('keydown', (e) => {
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
  });

  // å›¾ç‰‡é€‰æ‹©å¹¶å‘é€ï¼ˆè½¬ä¸º DataURLï¼‰
  imgBtn.addEventListener('click', () => imageInput.click());
  imageInput.addEventListener('change', (e) => {
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      const dataUrl = reader.result;
      push(messagesRef, { user: username, type: 'image', data: dataUrl, text: file.name, time: serverTimestamp() });
      imageInput.value = '';
    };
    reader.readAsDataURL(file);
  });

  // å½•éŸ³ï¼šå¼€å§‹/åœæ­¢ï¼Œä½¿ç”¨ MediaRecorder -> DataURL
  recBtn.addEventListener('click', async () => {
    if(mediaRecorder && mediaRecorder.state === 'recording'){
      // stop
      mediaRecorder.stop();
      recBtn.classList.remove('recording');
      recBtn.textContent = 'ğŸ¤';
      return;
    }

    // start recording
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½');
      return;
    }

    try{
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      recordingChunks = [];
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = (ev) => { if(ev.data && ev.data.size) recordingChunks.push(ev.data); };
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordingChunks, { type: 'audio/webm' });
        const reader = new FileReader();
        reader.onload = () => {
          const dataUrl = reader.result;
          push(messagesRef, { user: username, type: 'audio', data: dataUrl, time: serverTimestamp() });
        };
        reader.readAsDataURL(blob);
        // stop all tracks
        stream.getTracks().forEach(t=>t.stop());
      };

      mediaRecorder.start();
      recBtn.classList.add('recording');
      recBtn.textContent = 'â—';
    } catch(err){
      console.error(err);
      alert('æ— æ³•è®¿é—®éº¦å…‹é£: ' + err.message);
    }
  });

  // è‡ªåŠ¨ä¼¸ç¼© textarea
  function autoResizeTextarea(){
    textInput.style.height = 'auto';
    const max = 140; // px
    const newH = Math.min(textInput.scrollHeight, max);
    textInput.style.height = newH + 'px';
  }

  textInput.addEventListener('input', () => {
    autoResizeTextarea();
    // å½“ç”¨æˆ·è¾“å…¥æ—¶å‘ä¸Šæ»šåŠ¨æ¶ˆæ¯åŒºï¼Œä¿æŒæœ€åæ¶ˆæ¯å¯è§
    messagesEl.scrollTop = messagesEl.scrollHeight;
  });
  // åˆå§‹åŒ– textarea é«˜åº¦
  setTimeout(autoResizeTextarea, 50);

  const recentMessagesQuery = query(messagesRef, limitToLast(200));

  onChildAdded(recentMessagesQuery, (snapshot) => {
    const msg = snapshot.val();
    const el = createMessageElement(msg);
    messagesEl.appendChild(el);
    // ç¡®ä¿æ–°æ¶ˆæ¯å¯è§ï¼ˆè€ƒè™‘åº•éƒ¨ paddingï¼‰
    el.scrollIntoView({ block: 'nearest' });
  });
</script>

</body>
</html>
