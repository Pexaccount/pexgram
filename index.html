<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Pexgram</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --accent: linear-gradient(135deg, #7b61ff 0%, #39d7ff 100%);
      --text: rgba(255, 255, 255, 0.95);
      --muted: rgba(255, 255, 255, 0.65);
      --danger: #ff5656;
    }

    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: radial-gradient(ellipse at 10% 10%, #0f1724 0%, #071028 40%, #0b1220 100%);
      color: var(--text);
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 16px;
      min-height: 100vh;
    }

    /* === ç™»å½•/æ³¨å†Œé¢æ¿ === */
    #authPanel {
      width: 100%;
      max-width: 500px;
      background: rgba(255, 255, 255, 0.04);
      border-radius: 18px;
      padding: 50px 40px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 30px rgba(2, 6, 23, 0.6);
      display: flex;
      flex-direction: column;
      overflow: visible;
      min-height: auto;
      margin-top: 20px;
      margin-bottom: 20px;
    }

    .auth-title { font-size: 28px; font-weight: 700; margin: 0 0 30px 0; text-align: center; flex-shrink: 0; }
    .auth-form { display: flex; flex-direction: column; gap: 14px; overflow: visible; padding-right: 0; }
    .emoji-picker-container { display: none; position: absolute; bottom: 60px; left: 16px; background: rgba(255, 255, 255, 0.08);
      border-radius: 12px; padding: 8px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1000; }
    .emoji-picker-container.show { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; }
    .emoji-item { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 24px; border-radius: 8px; transition: all 0.2s; }
    .emoji-item:hover { background: rgba(255, 255, 255, 0.1); transform: scale(1.2); }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group label { font-size: 13px; color: var(--muted); font-weight: 500; }
    .form-group input {
      padding: 14px 16px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(255, 255, 255, 0.02);
      color: var(--text);
      outline: none;
      font-size: 15px;
      transition: border-color 0.2s;
    }
    .form-group input:focus { border-color: rgba(59, 130, 246, 0.5); }

    .auth-btn {
      padding: 14px 16px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.1s;
      flex-shrink: 0;
      margin-top: 10px;
      font-size: 15px;
    }
    .auth-btn:active { transform: scale(0.98); }

    .auth-tabs { display: flex; gap: 12px; margin-bottom: 20px; }
    .auth-tab { flex: 1; padding: 12px; border: none; border-radius: 10px; cursor: pointer;
      background: rgba(255, 255, 255, 0.02); color: var(--muted); transition: all 0.2s; font-weight: 500; }
    .auth-tab.active { background: var(--accent); color: #fff; }

    .auth-msg { font-size: 12px; color: var(--danger); margin-top: 8px; text-align: center; }

    /* === èŠå¤©ç•Œé¢ === */
    #chatPanel {
      width: 100%;
      max-width: 1200px;
      height: 90vh;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 30px rgba(2, 6, 23, 0.6);
      display: none;
      overflow: hidden;
      position: relative;
    }

    #chatPanel.active {
      display: flex;
    }

    #authPanel.hidden {
      display: none;
    }

    /* å·¦ä¾§ï¼šå¥½å‹å’Œç”¨æˆ·é¢æ¿ */
    .left-sidebar {
      width: 280px;
      border-right: 1px solid rgba(255, 255, 255, 0.04);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.01);
    }

    .user-profile {
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, #7b61ff 0%, #39d7ff 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      position: relative;
      overflow: hidden;
    }

    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-upload { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

    .user-info { flex: 1; min-width: 0; }
    .user-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-status { font-size: 11px; color: var(--muted); }

    .user-actions { display: flex; gap: 6px; }
    .icon-btn-small { width: 32px; height: 32px; border-radius: 50%; border: none; background: rgba(255, 255, 255, 0.05);
      color: var(--text); cursor: pointer; font-size: 14px; transition: background 0.2s; }
    .icon-btn-small:hover { background: rgba(255, 255, 255, 0.1); }

    .sidebar-section-title { font-size: 11px; color: var(--muted); text-transform: uppercase; padding: 12px 12px 6px 12px;
      font-weight: 600; margin-top: 6px; }

    #friendsList { flex: 1; overflow-y: auto; padding: 6px 0; }
    .friend-item { padding: 10px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px;
      border-left: 3px solid transparent; transition: all 0.2s; }
    .friend-item:hover { background: rgba(255, 255, 255, 0.05); }
    .friend-item.active { background: rgba(59, 130, 246, 0.1); border-left-color: #39d7ff; }
    .friend-item .avatar-sm { width: 32px; height: 32px; border-radius: 50%; background: #7b61ff; flex-shrink: 0; }
    .friend-info { flex: 1; min-width: 0; }
    .friend-name { font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .add-friend-btn { width: calc(100% - 24px); margin: 12px; border: none; border-radius: 8px; padding: 10px;
      background: rgba(59, 130, 246, 0.15); color: #39d7ff; cursor: pointer; font-size: 12px; transition: all 0.2s; }
    .add-friend-btn:hover { background: rgba(59, 130, 246, 0.25); }

    /* å³ä¾§ï¼šèŠå¤©åŒº */
    .chat-main { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }

    .chat-header { padding: 12px 16px; border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      display: flex; align-items: center; justify-content: space-between; position: relative; }
    .chat-header h3 { margin: 0; font-size: 14px; }
    .chat-header-info { font-size: 11px; color: var(--muted); }
    .contact-btn { width: 36px; height: 36px; border-radius: 50%; border: none; background: rgba(255, 255, 255, 0.05);
      color: var(--text); cursor: pointer; font-size: 16px; transition: all 0.2s; }
    .contact-btn:hover { background: rgba(255, 255, 255, 0.1); }
    .contact-menu { display: none; position: absolute; top: 50px; right: 16px; background: rgba(255, 255, 255, 0.08);
      border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); min-width: 220px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3); z-index: 1000; }
    .contact-menu.show { display: block; }
    .contact-item { padding: 12px 16px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); cursor: pointer;
      transition: all 0.2s; font-size: 12px; }
    .contact-item:last-child { border-bottom: none; }
    .contact-item:hover { background: rgba(255, 255, 255, 0.05); }
    .contact-label { color: var(--muted); font-size: 11px; margin-right: 8px; }
    .contact-text { color: var(--text); word-break: break-all; }

    #messagesArea { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }

    .msg { display: flex; flex-direction: column; align-items: flex-start; gap: 4px; animation: slideIn 0.3s ease; }
    .msg.me { align-items: flex-end; }

    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .msg-meta { font-size: 11px; color: var(--muted); }
    .msg-bubble { max-width: 70%; padding: 10px 14px; border-radius: 12px;
      background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.04); word-break: break-word; }
    .msg.me .msg-bubble { background: rgba(59, 130, 246, 0.18); border-color: rgba(59, 130, 246, 0.25); }

    .msg-bubble img { max-width: 100%; border-radius: 8px; margin-bottom: 6px; cursor: pointer; transition: transform 0.2s; }
    .msg-bubble img:hover { transform: scale(1.05); }
    .image-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9);
      z-index: 2000; align-items: center; justify-content: center; }
    .image-modal.show { display: flex; }
    .image-modal img { max-width: 90%; max-height: 90%; border-radius: 8px; }
    .msg-bubble audio { width: 100%; max-width: 300px; margin-top: 6px; }
    .msg-bubble a { color: #39d7ff; text-decoration: none; }

    /* è¾“å…¥åŒº */
    .input-area {
      padding: 12px 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.04);
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: rgba(255, 255, 255, 0.01);
    }

    .input-toolbar { display: flex; gap: 8px; align-items: center; }
    .icon-btn { width: 36px; height: 36px; border-radius: 50%; border: none;
      background: rgba(255, 255, 255, 0.05); color: var(--text); cursor: pointer; font-size: 16px;
      transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
    .icon-btn:hover { background: rgba(255, 255, 255, 0.1); }
    .icon-btn.recording { background: var(--danger); box-shadow: 0 0 12px rgba(255, 86, 86, 0.3); }

    #inputBox { display: flex; gap: 8px; align-items: flex-end; }
    .input-wrapper { flex: 1; display: flex; flex-direction: column; gap: 4px; }
    textarea#msgInput { width: 100%; min-height: 36px; max-height: 120px; resize: none;
      padding: 8px 12px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(255, 255, 255, 0.02); color: var(--text); outline: none; font-family: inherit;
      font-size: 13px; transition: all 0.2s; line-height: 1.4; }
    textarea#msgInput:focus { border-color: rgba(59, 130, 246, 0.5); box-shadow: 0 0 8px rgba(59, 130, 246, 0.1); }

    #sendBtn { padding: 8px 16px; border-radius: 999px; border: none; background: var(--accent);
      color: #fff; cursor: pointer; font-weight: 600; transition: all 0.1s; font-size: 13px; white-space: nowrap; }
    #sendBtn:active { transform: scale(0.95); }

    .hidden-input { display: none; }

    /* å“åº”å¼ */
    @media (max-width: 900px) {
      .left-sidebar { width: 220px; }
      #messagesArea { padding: 12px; }
      .msg-bubble { max-width: 80%; }
    }

    @media (max-width: 768px) {
      body { padding: 6px; }
      #authPanel { padding: 30px 20px; max-width: 100%; overflow: visible; }
      #chatPanel { max-width: 100%; height: 100vh; }
      .left-sidebar { width: 200px; }
    }

    @media (max-width: 640px) {
      body { padding: 4px; }
      #authPanel { padding: 20px 16px; max-width: 100%; overflow: visible; }
      #chatPanel { max-width: 100%; height: 100vh; }
      .left-sidebar { display: none; position: absolute; width: 220px; height: 100%; left: 0; top: 0; z-index: 100;
        background: rgba(15, 23, 36, 0.98); border-right-width: 2px; }
      .left-sidebar.mobile-show { display: flex; }
      .chat-main { width: 100%; }
      #messagesArea { padding: 12px; }
      .msg-bubble { max-width: 85%; }
      textarea#msgInput { font-size: 14px; }
    }
  </style>
</head>
<body>

<!-- ç™»å½•/æ³¨å†Œé¢æ¿ -->
<div id="authPanel" class="active">
  <h2 class="auth-title">Pexgram</h2>
  <div class="auth-form">
    <div class="auth-tabs">
      <button class="auth-tab active" data-mode="login">ç™»å½•</button>
      <button class="auth-tab" data-mode="register">æ³¨å†Œ</button>
      <button class="auth-tab" data-mode="change-password">æ”¹å¯†ç </button>
      <button class="auth-tab" data-mode="anonymous">åŒ¿å</button>
    </div>

    <!-- ç™»å½•è¡¨å• -->
    <div id="loginForm">
      <div class="form-group">
        <label>ç”¨æˆ·å</label>
        <input type="text" id="loginUsername" placeholder="è¾“å…¥ç”¨æˆ·å">
      </div>
      <div class="form-group">
        <label>å¯†ç </label>
        <input type="password" id="loginPassword" placeholder="è¾“å…¥å¯†ç ">
      </div>
      <button class="auth-btn" id="loginBtn">ç™»å½•</button>
      <div id="loginMsg" class="auth-msg"></div>
    </div>

    <!-- æ³¨å†Œè¡¨å• -->
    <div id="registerForm" style="display: none;">
      <div class="form-group">
        <label>ç”¨æˆ·å</label>
        <input type="text" id="regUsername" placeholder="è¾“å…¥ç”¨æˆ·åï¼ˆ3-20ä¸ªå­—ç¬¦ï¼‰">
      </div>
      <div class="form-group">
        <label>å¯†ç </label>
        <input type="password" id="regPassword" placeholder="è¾“å…¥å¯†ç ï¼ˆ6ä½ä»¥ä¸Šï¼‰">
      </div>
      <div class="form-group">
        <label>ç¡®è®¤å¯†ç </label>
        <input type="password" id="regPassword2" placeholder="å†æ¬¡è¾“å…¥å¯†ç ">
      </div>
      <button class="auth-btn" id="registerBtn">æ³¨å†Œ</button>
      <div id="registerMsg" class="auth-msg"></div>
    </div>

    <!-- ä¿®æ”¹å¯†ç è¡¨å• -->
    <div id="changePasswordForm" style="display: none;">
      <div class="form-group">
        <label>ç”¨æˆ·å</label>
        <input type="text" id="cpUsername" placeholder="è¾“å…¥ç”¨æˆ·å">
      </div>
      <div class="form-group">
        <label>æ—§å¯†ç </label>
        <input type="password" id="cpOldPassword" placeholder="è¾“å…¥æ—§å¯†ç ">
      </div>
      <div class="form-group">
        <label>æ–°å¯†ç </label>
        <input type="password" id="cpNewPassword" placeholder="è¾“å…¥æ–°å¯†ç ï¼ˆ6ä½ä»¥ä¸Šï¼‰">
      </div>
      <div class="form-group">
        <label>ç¡®è®¤æ–°å¯†ç </label>
        <input type="password" id="cpNewPassword2" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
      </div>
      <button class="auth-btn" id="changePasswordBtn">ä¿®æ”¹å¯†ç </button>
      <div id="changePasswordMsg" class="auth-msg"></div>
    </div>

    <!-- åŒ¿åæ¨¡å¼ -->
    <div id="anonForm" style="display: none;">
      <p style="font-size: 12px; color: var(--muted); text-align: center; margin-bottom: 20px;">
        ä»¥åŒ¿åèº«ä»½è¿›å…¥å…¨çƒèŠå¤©å®¤ï¼Œæ— æ³•ä½¿ç”¨å¥½å‹åŠŸèƒ½ã€‚
      </p>
      <button class="auth-btn" id="anonBtn">è¿›å…¥åŒ¿åèŠå¤©</button>
    </div>
  </div>
</div>

<!-- èŠå¤©é¢æ¿ -->
<div id="chatPanel">
  <!-- å·¦ä¾§ï¼šå¥½å‹åˆ—è¡¨ -->
  <div class="left-sidebar">
    <!-- ç”¨æˆ·ä¿¡æ¯ -->
    <div class="user-profile">
      <div class="avatar" id="userAvatar">
        <input type="file" class="avatar-upload" id="avatarUpload" accept="image/*">
        <span id="avatarText">ğŸ‘¤</span>
      </div>
      <div class="user-info">
        <div class="user-name" id="currentUsername">ç”¨æˆ·</div>
        <div class="user-status" id="userStatus">åœ¨çº¿</div>
      </div>
      <div class="user-actions">
        <button class="icon-btn-small" id="logoutBtn" title="ç™»å‡º">ğŸšª</button>
      </div>
    </div>

    <!-- å¥½å‹åˆ—è¡¨ -->
    <div class="sidebar-section-title">å¥½å‹</div>
    <div id="friendsList"></div>
    <button class="add-friend-btn" id="addFriendBtn">+ æ·»åŠ å¥½å‹</button>
  </div>

  <!-- å³ä¾§ï¼šèŠå¤©åŒº -->
  <div class="chat-main">
    <!-- èŠå¤©å¤´éƒ¨ -->
    <div class="chat-header">
      <div>
        <h3 id="chatTitle">å…¨çƒèŠå¤©</h3>
        <div class="chat-header-info" id="chatInfo">å®æ—¶èŠå¤©</div>
      </div>
      <button class="contact-btn" id="contactBtn" title="è”ç³»æ–¹å¼">ğŸ“‹</button>
      <div class="contact-menu" id="contactMenu">
        <div class="contact-item">
          <span class="contact-label">æ‰‹æœº:</span>
          <span class="contact-text">18630399822</span>
        </div>
        <div class="contact-item">
          <span class="contact-label">å¾®ä¿¡:</span>
          <span class="contact-text">pwwanghe</span>
        </div>
        <div class="contact-item">
          <span class="contact-label">é‚®ä»¶:</span>
          <span class="contact-text">pwwanghe@outlook.com</span>
        </div>
        <div class="contact-item">
          <span class="contact-label">Telegram:</span>
          <span class="contact-text">@pwerngw</span>
        </div>
      </div>
    </div>

    <!-- æ¶ˆæ¯åŒº -->
    <div id="messagesArea"></div>

    <!-- è¾“å…¥åŒº -->
    <div class="input-area">
      <div class="input-toolbar">
        <button class="icon-btn" id="emojiBtn" title="è¡¨æƒ…">ğŸ˜Š</button>
        <div id="emojiPicker" class="emoji-picker-container"></div>

        <button class="icon-btn" id="uploadImgBtn" title="ä¸Šä¼ å›¾ç‰‡">ğŸ–¼ï¸</button>
        <input type="file" id="imgInput" class="hidden-input" accept="image/*">

        <button class="icon-btn" id="uploadFileBtn" title="ä¸Šä¼ æ–‡ä»¶">ğŸ“</button>
        <input type="file" id="fileInput" class="hidden-input">

        <button class="icon-btn" id="recordBtn" title="å½•éŸ³">ğŸ¤</button>
      </div>

      <div id="inputBox">
        <div class="input-wrapper">
          <textarea id="msgInput" placeholder="è¾“å…¥æ¶ˆæ¯... (Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ)" maxlength="2000"></textarea>
        </div>
        <button id="sendBtn">å‘é€</button>
      </div>
    </div>
  </div>
</div>

<!-- å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡† -->
<div class="image-modal" id="imageModal">
  <img id="modalImage" src="" alt="æ”¾å¤§å›¾ç‰‡">
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, set, get, update, query, limitToLast } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAlOYUdwcNWWueaj7X9RdzzkAk_r-_JWL8",
    authDomain: "pexchatweb.firebaseapp.com",
    databaseURL: "https://pexchatweb-default-rtdb.firebaseio.com",
    projectId: "pexchatweb",
    storageBucket: "pexchatweb.firebasestorage.app",
    messagingSenderId: "157034955766",
    appId: "1:157034955766:web:076f39819c081d73b8fdd7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // === çŠ¶æ€ç®¡ç† ===
  let currentUser = null; // { uid, username, avatar, isAnonymous }
  let currentChatId = 'global';
  let mediaRecorder = null;
  let mediaStream = null;
  let recordingChunks = [];
  let isRecording = false;

  // === UI å…ƒç´  ===
  const authPanel = document.getElementById('authPanel');
  const chatPanel = document.getElementById('chatPanel');
  const authTabs = document.querySelectorAll('.auth-tab');
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const anonForm = document.getElementById('anonForm');

  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');
  const messagesArea = document.getElementById('messagesArea');
  const friendsList = document.getElementById('friendsList');
  const currentUsername = document.getElementById('currentUsername');
  const userStatus = document.getElementById('userStatus');
  const logoutBtn = document.getElementById('logoutBtn');
  const chatTitle = document.getElementById('chatTitle');
  const chatInfo = document.getElementById('chatInfo');

  const uploadImgBtn = document.getElementById('uploadImgBtn');
  const imgInput = document.getElementById('imgInput');
  const uploadFileBtn = document.getElementById('uploadFileBtn');
  const fileInput = document.getElementById('fileInput');
  const recordBtn = document.getElementById('recordBtn');
  const addFriendBtn = document.getElementById('addFriendBtn');
  const userAvatar = document.getElementById('userAvatar');
  const avatarText = document.getElementById('avatarText');
  const avatarUpload = document.getElementById('avatarUpload');
  const emojiBtn = document.getElementById('emojiBtn');
  const emojiPicker = document.getElementById('emojiPicker');
  const contactBtn = document.getElementById('contactBtn');
  const contactMenu = document.getElementById('contactMenu');
  const changePasswordForm = document.getElementById('changePasswordForm');
  const changePasswordBtn = document.getElementById('changePasswordBtn');

  // === è®¤è¯ç›¸å…³ ===
  document.getElementById('loginBtn').addEventListener('click', login);
  document.getElementById('registerBtn').addEventListener('click', register);
  document.getElementById('changePasswordBtn').addEventListener('click', changePassword);
  document.getElementById('anonBtn').addEventListener('click', () => enterAnonymous());

  authTabs.forEach(tab => {
    tab.addEventListener('click', (e) => {
      authTabs.forEach(t => t.classList.remove('active'));
      e.target.classList.add('active');

      loginForm.style.display = 'none';
      registerForm.style.display = 'none';
      changePasswordForm.style.display = 'none';
      anonForm.style.display = 'none';

      if (e.target.dataset.mode === 'login') loginForm.style.display = 'flex';
      else if (e.target.dataset.mode === 'register') registerForm.style.display = 'flex';
      else if (e.target.dataset.mode === 'change-password') changePasswordForm.style.display = 'flex';
      else if (e.target.dataset.mode === 'anonymous') anonForm.style.display = 'flex';
    });
  });

  async function register() {
    const username = document.getElementById('regUsername').value.trim();
    const password = document.getElementById('regPassword').value;
    const password2 = document.getElementById('regPassword2').value;
    const msg = document.getElementById('registerMsg');

    if (!username || username.length < 3 || username.length > 20) {
      msg.textContent = 'ç”¨æˆ·åéœ€ä¸º 3-20 ä¸ªå­—ç¬¦';
      return;
    }
    if (!password || password.length < 6) {
      msg.textContent = 'å¯†ç éœ€è‡³å°‘ 6 ä½';
      return;
    }
    if (password !== password2) {
      msg.textContent = 'ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´';
      return;
    }

    try {
      const usersRef = ref(db, 'users');
      const snapshot = await get(usersRef);
      const users = snapshot.val() || {};

      for (const uid in users) {
        if (users[uid].username === username) {
          msg.textContent = 'ç”¨æˆ·åå·²è¢«æ³¨å†Œ';
          return;
        }
      }

      const uid = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      const passwordHash = btoa(username + ':' + password);

      await set(ref(db, `users/${uid}`), {
        username,
        passwordHash,
        avatar: 'ğŸ‘¤',
        friends: [],
        createdAt: Date.now()
      });

      msg.textContent = 'æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•';
      setTimeout(() => {
        document.querySelector('[data-mode="login"]').click();
        document.getElementById('loginUsername').value = username;
        document.getElementById('loginPassword').value = '';
      }, 1000);
    } catch (err) {
      msg.textContent = 'æ³¨å†Œå¤±è´¥ï¼š' + err.message;
    }
  }

  async function login() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    const msg = document.getElementById('loginMsg');

    if (!username || !password) {
      msg.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
      return;
    }

    try {
      const usersRef = ref(db, 'users');
      const snapshot = await get(usersRef);
      const users = snapshot.val() || {};

      let foundUser = null;
      for (const uid in users) {
        if (users[uid].username === username) {
          const expectedHash = btoa(username + ':' + password);
          if (users[uid].passwordHash === expectedHash) {
            foundUser = { uid, ...users[uid] };
          }
          break;
        }
      }

      if (!foundUser) {
        msg.textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
        return;
      }

      currentUser = { uid: foundUser.uid, username: foundUser.username, avatar: foundUser.avatar, isAnonymous: false };
      enterChat();
    } catch (err) {
      msg.textContent = 'ç™»å½•å¤±è´¥ï¼š' + err.message;
    }
  }

  async function changePassword() {
    const username = document.getElementById('cpUsername').value.trim();
    const oldPassword = document.getElementById('cpOldPassword').value;
    const newPassword = document.getElementById('cpNewPassword').value;
    const newPassword2 = document.getElementById('cpNewPassword2').value;
    const msg = document.getElementById('changePasswordMsg');

    if (!username || !oldPassword || !newPassword || !newPassword2) {
      msg.textContent = 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µ';
      return;
    }
    if (newPassword.length < 6) {
      msg.textContent = 'æ–°å¯†ç éœ€è‡³å°‘ 6 ä½';
      return;
    }
    if (newPassword !== newPassword2) {
      msg.textContent = 'ä¸¤æ¬¡æ–°å¯†ç ä¸ä¸€è‡´';
      return;
    }

    try {
      const usersRef = ref(db, 'users');
      const snapshot = await get(usersRef);
      const users = snapshot.val() || {};

      let foundUser = null;
      for (const uid in users) {
        if (users[uid].username === username) {
          const expectedHash = btoa(username + ':' + oldPassword);
          if (users[uid].passwordHash === expectedHash) {
            foundUser = { uid, ...users[uid] };
          }
          break;
        }
      }

      if (!foundUser) {
        msg.textContent = 'ç”¨æˆ·åæˆ–æ—§å¯†ç é”™è¯¯';
        return;
      }

      const newHash = btoa(username + ':' + newPassword);
      await update(ref(db, `users/${foundUser.uid}`), { passwordHash: newHash });

      msg.textContent = 'å¯†ç ä¿®æ”¹æˆåŠŸï¼';
      msg.style.color = '#39d7ff';
      setTimeout(() => {
        document.querySelector('[data-mode="login"]').click();
        document.getElementById('loginUsername').value = username;
        document.getElementById('loginPassword').value = '';
        document.getElementById('cpUsername').value = '';
        document.getElementById('cpOldPassword').value = '';
        document.getElementById('cpNewPassword').value = '';
        document.getElementById('cpNewPassword2').value = '';
        msg.style.color = 'var(--danger)';
        msg.textContent = '';
      }, 1500);
    } catch (err) {
      msg.textContent = 'ä¿®æ”¹å¤±è´¥ï¼š' + err.message;
    }
  }

  function enterAnonymous() {
    currentUser = { uid: 'anon_' + Date.now(), username: 'åŒ¿å_' + Math.floor(Math.random() * 10000), avatar: 'ğŸ‘¤', isAnonymous: true };
    enterChat();
  }

  function enterChat() {
    authPanel.classList.add('hidden');
    chatPanel.classList.add('active');
    currentUsername.textContent = currentUser.username;
    userStatus.textContent = currentUser.isAnonymous ? 'åŒ¿å' : 'åœ¨çº¿';
    avatarText.textContent = currentUser.avatar || 'ğŸ‘¤';
    loadGlobalChat();
    if (!currentUser.isAnonymous) {
      loadFriends();
      loadPendingRequests();
      addFriendBtn.style.display = 'block';
    } else {
      addFriendBtn.style.display = 'none';
    }
  }

  // === æ¶ˆæ¯ç›¸å…³ ===
  // å­˜å‚¨å·²æ˜¾ç¤ºçš„æ¶ˆæ¯ keyï¼Œé¿å…é‡å¤
  const displayedMsgKeys = new Set();

  function loadGlobalChat() {
    messagesArea.innerHTML = '';
    displayedMsgKeys.clear();
    currentChatId = 'global';
    chatTitle.textContent = 'å…¨çƒèŠå¤©';
    chatInfo.textContent = 'æ‰€æœ‰ç”¨æˆ·å®æ—¶èŠå¤©';

    // å…ˆè·å–æ‰€æœ‰å†å²æ¶ˆæ¯
    const messagesRef = ref(db, 'chats/global/messages');
    get(messagesRef).then(snapshot => {
      if (snapshot.exists()) {
        const data = snapshot.val();
        // æŒ‰æ—¶é—´æ’åº
        const sorted = Object.entries(data)
          .map(([key, val]) => ({ key, ...val }))
          .sort((a, b) => (a.time || 0) - (b.time || 0));
        
        sorted.forEach(msg => {
          appendMessage(msg, msg.key);
          displayedMsgKeys.add(msg.key);
        });
      }
      
      // ç„¶åç›‘å¬æ–°æ¶ˆæ¯
      onChildAdded(ref(db, 'chats/global/messages'), (snapshot) => {
        const key = snapshot.key;
        if (!displayedMsgKeys.has(key)) {
          displayedMsgKeys.add(key);
          const msg = snapshot.val();
          appendMessage(msg, key);
        }
      });
    });
  }

  function appendMessage(msg, key) {
    if (!msg) return;

    const div = document.createElement('div');
    div.className = 'msg' + (msg.uid === currentUser.uid ? ' me' : '');
    
    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = 'msg-bubble';

    // å…ˆæ·»åŠ å†…å®¹
    if (msg.type === 'image' && msg.data) {
      const img = document.createElement('img');
      img.src = msg.data;
      img.alt = 'image';
      bubbleDiv.appendChild(img);
      attachImageClickListener(img);
    } else if (msg.type === 'audio' && msg.data) {
      const audio = document.createElement('audio');
      audio.controls = true;
      audio.src = msg.data;
      bubbleDiv.appendChild(audio);
    } else if (msg.type === 'file' && msg.fileUrl) {
      const link = document.createElement('a');
      link.href = msg.fileUrl;
      link.textContent = msg.fileName || 'ä¸‹è½½æ–‡ä»¶';
      link.target = '_blank';
      bubbleDiv.appendChild(link);
    } else {
      bubbleDiv.textContent = msg.text || '';
    }

    // ç»“æ„ï¼šå¦‚æœæ˜¯åˆ«äººçš„æ¶ˆæ¯ï¼Œå…ˆæ˜¾ç¤ºç”¨æˆ·åï¼Œå†æ˜¾ç¤ºæ°”æ³¡ï¼›è‡ªå·±çš„æ¶ˆæ¯åªæ˜¾ç¤ºæ°”æ³¡
    if (msg.uid !== currentUser.uid) {
      const metaDiv = document.createElement('div');
      metaDiv.className = 'msg-meta';
      metaDiv.textContent = msg.username || 'æœªçŸ¥ç”¨æˆ·';
      div.appendChild(metaDiv);
    }
    div.appendChild(bubbleDiv);
    messagesArea.appendChild(div);
    messagesArea.scrollTop = messagesArea.scrollHeight;
  }

  sendBtn.addEventListener('click', sendMessage);
  msgInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  function sendMessage() {
    const text = msgInput.value.trim();
    if (!text) return;

    push(ref(db, `chats/${currentChatId}/messages`), {
      uid: currentUser.uid,
      username: currentUser.username,
      text,
      type: 'text',
      time: Date.now()
    });

    msgInput.value = '';
    autoResizeInput();
  }

  function autoResizeInput() {
    msgInput.style.height = 'auto';
    const maxHeight = 120;
    const newHeight = Math.min(msgInput.scrollHeight, maxHeight);
    msgInput.style.height = newHeight + 'px';
  }

  msgInput.addEventListener('input', autoResizeInput);

  // === å›¾ç‰‡ä¸Šä¼  ===
  uploadImgBtn.addEventListener('click', () => imgInput.click());
  imgInput.addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      push(ref(db, `chats/${currentChatId}/messages`), {
        uid: currentUser.uid,
        username: currentUser.username,
        type: 'image',
        data: reader.result,
        time: Date.now()
      });
      imgInput.value = '';
    };
    reader.readAsDataURL(file);
  });

  // === æ–‡ä»¶ä¸Šä¼  ===
  uploadFileBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      push(ref(db, `chats/${currentChatId}/messages`), {
        uid: currentUser.uid,
        username: currentUser.username,
        type: 'file',
        fileUrl: reader.result,
        fileName: file.name,
        time: Date.now()
      });
      fileInput.value = '';
    };
    reader.readAsDataURL(file);
  });


  function loadFriends() {
    if (currentUser.isAnonymous) return;

    const userRef = ref(db, `users/${currentUser.uid}`);
    get(userRef).then(snapshot => {
      const userData = snapshot.val();
      const friends = userData?.friends || [];

      friendsList.innerHTML = '';
      friends.forEach(friendId => {
        get(ref(db, `users/${friendId}`)).then(friendSnapshot => {
          if (!friendSnapshot.exists()) return;
          const friend = friendSnapshot.val();

          const div = document.createElement('div');
          div.className = 'friend-item';
          div.innerHTML = `
            <div class="avatar-sm" style="background: linear-gradient(135deg, #7b61ff, #39d7ff);">${friend.avatar || 'ğŸ‘¤'}</div>
            <div class="friend-info">
              <div class="friend-name">${friend.username}</div>
            </div>
          `;

          div.addEventListener('click', () => openChat(friendId, friend.username));
          friendsList.appendChild(div);
        });
      });
    });
  }

  function openChat(friendId, friendName) {
    const chatId = [currentUser.uid, friendId].sort().join('_');
    currentChatId = chatId;
    chatTitle.textContent = friendName;
    chatInfo.textContent = 'ç§èŠ';

    messagesArea.innerHTML = '';
    displayedMsgKeys.clear();
    
    // å…ˆåŠ è½½å†å²æ¶ˆæ¯
    const messagesRef = ref(db, `chats/${chatId}/messages`);
    get(messagesRef).then(snapshot => {
      if (snapshot.exists()) {
        const data = snapshot.val();
        const sorted = Object.entries(data)
          .map(([key, val]) => ({ key, ...val }))
          .sort((a, b) => (a.time || 0) - (b.time || 0));
        
        sorted.forEach(msg => {
          appendMessage(msg, msg.key);
          displayedMsgKeys.add(msg.key);
        });
      }
      
      // ç›‘å¬æ–°æ¶ˆæ¯
      onChildAdded(ref(db, `chats/${chatId}/messages`), (snapshot) => {
        const key = snapshot.key;
        if (!displayedMsgKeys.has(key)) {
          displayedMsgKeys.add(key);
          const msg = snapshot.val();
          appendMessage(msg, key);
        }
      });
    });
  }

  addFriendBtn.addEventListener('click', () => {
    const friendUsername = prompt('è¾“å…¥å¥½å‹ç”¨æˆ·åï¼š');
    if (!friendUsername) return;

    get(ref(db, 'users')).then(snapshot => {
      const users = snapshot.val() || {};
      let friendId = null;

      for (const uid in users) {
        if (users[uid].username === friendUsername) {
          friendId = uid;
          break;
        }
      }

      if (!friendId) {
        alert('ç”¨æˆ·ä¸å­˜åœ¨');
        return;
      }

      if (friendId === currentUser.uid) {
        alert('ä¸èƒ½æ·»åŠ è‡ªå·±');
        return;
      }

      // æ£€æŸ¥æ˜¯å¦å·²æ˜¯å¥½å‹
      get(ref(db, `users/${currentUser.uid}`)).then(snapshot => {
        const userData = snapshot.val();
        const friends = userData?.friends || [];

        if (friends.includes(friendId)) {
          alert('å·²æ˜¯å¥½å‹');
          return;
        }

        // å‘é€å¥½å‹ç”³è¯·
        const requests = userData?.friendRequests || [];
        if (requests.includes(friendId)) {
          alert('å·²å‘é€ç”³è¯·ï¼Œè¯·ç­‰å¾…å¯¹æ–¹åŒæ„');
          return;
        }

        requests.push(friendId);
        update(ref(db, `users/${currentUser.uid}`), { friendRequests: requests });

        // åŒæ—¶åœ¨å¯¹æ–¹çš„å¾…æ”¶åˆ—è¡¨ä¸­æ·»åŠ 
        get(ref(db, `users/${friendId}`)).then(friendSnapshot => {
          const friendData = friendSnapshot.val();
          const pendingRequests = friendData?.pendingFriendRequests || [];
          if (!pendingRequests.includes(currentUser.uid)) {
            pendingRequests.push(currentUser.uid);
            update(ref(db, `users/${friendId}`), { pendingFriendRequests: pendingRequests });
          }
        });

        alert('ç”³è¯·å·²å‘é€ï¼');
      });
    });
  });

  // === åŠ è½½å¾…æ”¶çš„å¥½å‹ç”³è¯· ===
  function loadPendingRequests() {
    if (currentUser.isAnonymous) return;

    const userRef = ref(db, `users/${currentUser.uid}`);
    get(userRef).then(snapshot => {
      const userData = snapshot.val();
      const pending = userData?.pendingFriendRequests || [];

      if (pending.length === 0) return;

      // åˆ›å»ºä¸€ä¸ªå¾…å®¡æ‰¹åˆ—è¡¨å®¹å™¨ï¼ˆå¯é€‰ï¼‰
      pending.forEach(requesterId => {
        get(ref(db, `users/${requesterId}`)).then(requesterSnapshot => {
          if (!requesterSnapshot.exists()) return;
          const requester = requesterSnapshot.val();

          // å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
          const accept = confirm(`${requester.username} æƒ³æ·»åŠ ä½ ä¸ºå¥½å‹ï¼Œæ˜¯å¦åŒæ„ï¼Ÿ`);
          
          if (accept) {
            // åŒæ„ï¼šåŒæ–¹éƒ½åŠ å…¥å¥½å‹åˆ—è¡¨
            get(ref(db, `users/${currentUser.uid}`)).then(mySnapshot => {
              const myData = mySnapshot.val();
              const myFriends = myData?.friends || [];
              const myPending = myData?.pendingFriendRequests || [];

              if (!myFriends.includes(requesterId)) {
                myFriends.push(requesterId);
              }
              myPending.splice(myPending.indexOf(requesterId), 1);

              update(ref(db, `users/${currentUser.uid}`), {
                friends: myFriends,
                pendingFriendRequests: myPending
              });
            });

            // æ›´æ–°å¯¹æ–¹
            get(ref(db, `users/${requesterId}`)).then(requesterSnapshot2 => {
              const requesterData = requesterSnapshot2.val();
              const requesterFriends = requesterData?.friends || [];
              const requesterSent = requesterData?.friendRequests || [];

              if (!requesterFriends.includes(currentUser.uid)) {
                requesterFriends.push(currentUser.uid);
              }
              requesterSent.splice(requesterSent.indexOf(currentUser.uid), 1);

              update(ref(db, `users/${requesterId}`), {
                friends: requesterFriends,
                friendRequests: requesterSent
              });
            });

            loadFriends();
          } else {
            // æ‹’ç»
            get(ref(db, `users/${currentUser.uid}`)).then(mySnapshot => {
              const myData = mySnapshot.val();
              const myPending = myData?.pendingFriendRequests || [];
              myPending.splice(myPending.indexOf(requesterId), 1);
              update(ref(db, `users/${currentUser.uid}`), { pendingFriendRequests: myPending });
            });

            get(ref(db, `users/${requesterId}`)).then(requesterSnapshot2 => {
              const requesterData = requesterSnapshot2.val();
              const requesterSent = requesterData?.friendRequests || [];
              requesterSent.splice(requesterSent.indexOf(currentUser.uid), 1);
              update(ref(db, `users/${requesterId}`), { friendRequests: requesterSent });
            });
          }
        });
      });
    });
  }

  // === å¤´åƒç®¡ç† ===
  userAvatar.addEventListener('click', () => {
    avatarUpload.click();
  });

  avatarUpload.addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    if (!file || currentUser.isAnonymous) return;

    const reader = new FileReader();
    reader.onload = () => {
      const dataUrl = reader.result;
      avatarText.textContent = ''; // éšè—æ–‡å­—ï¼Œæ˜¾ç¤ºå›¾ç‰‡
      userAvatar.style.backgroundImage = `url(${dataUrl})`;
      userAvatar.style.backgroundSize = 'cover';

      // æ›´æ–°åˆ°æ•°æ®åº“
      update(ref(db, `users/${currentUser.uid}`), { avatar: dataUrl });
      currentUser.avatar = dataUrl;
    };
    reader.readAsDataURL(file);
  });

  // === ç™»å‡º ===
  logoutBtn.addEventListener('click', () => {
    if (confirm('ç¡®å®šè¦ç™»å‡ºå—ï¼Ÿ')) {
      currentUser = null;
      authPanel.classList.remove('hidden');
      chatPanel.classList.remove('active');
      document.getElementById('loginUsername').value = '';
      document.getElementById('loginPassword').value = '';
      messagesArea.innerHTML = '';
    }
  });

  // === è”ç³»æ–¹å¼èœå• ===
  contactBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    contactMenu.classList.toggle('show');
  });

  document.addEventListener('click', (e) => {
    if (!e.target.closest('#contactBtn') && !e.target.closest('#contactMenu')) {
      contactMenu.classList.remove('show');
    }
  });

  // === å›¾ç‰‡æ”¾å¤§ ===
  const imageModal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');

  function attachImageClickListener(img) {
    img.addEventListener('click', (e) => {
      e.stopPropagation();
      modalImage.src = img.src;
      imageModal.classList.add('show');
    });
  }

  imageModal.addEventListener('click', () => {
    imageModal.classList.remove('show');
  });

  // === è¡¨æƒ…åŒ…åŠŸèƒ½ ===
  const emojis = ['ğŸ˜Š', 'ğŸ˜‚', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤”', 'ğŸ˜´', 'ğŸ˜¤', 'ğŸ˜¡', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ¤©',
    'ğŸ™ƒ', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ˜’', 'ğŸ¥±', 'ğŸ˜²', 'ğŸ¤¨', 'ğŸ˜•', 'ğŸ« ', 'ğŸ˜³', 'ğŸ¥º', 'ğŸ˜±',
    'ğŸ‘', 'ğŸ‘', 'â¤ï¸', 'ğŸ”¥', 'âœ¨', 'ğŸ‰', 'ğŸŠ', 'ğŸ’¯', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤', 'ğŸ’ª',
    'ğŸ±', 'ğŸ¶', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®'];

  function initEmojiPicker() {
    emojis.forEach(emoji => {
      const btn = document.createElement('div');
      btn.className = 'emoji-item';
      btn.textContent = emoji;
      btn.addEventListener('click', () => {
        msgInput.value += emoji;
        emojiPicker.classList.remove('show');
      });
      emojiPicker.appendChild(btn);
    });
  }

  emojiBtn.addEventListener('click', () => {
    emojiPicker.classList.toggle('show');
  });

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.input-toolbar')) {
      emojiPicker.classList.remove('show');
    }
  });

  // === æ”¹è¿›çš„è¯­éŸ³å½•åˆ¶ ===
  recordBtn.addEventListener('click', async () => {
    if (isRecording) {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
      }
      recordBtn.classList.remove('recording');
      recordBtn.textContent = 'ğŸ¤';
      isRecording = false;
      return;
    }

    try {
      // åœæ­¢ä»»ä½•æ­£åœ¨è¿›è¡Œçš„æµ
      if (mediaStream) {
        mediaStream.getTracks().forEach(t => t.stop());
      }

      // è¯·æ±‚éº¦å…‹é£æƒé™
      mediaStream = await navigator.mediaDevices.getUserMedia({
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: true
        }
      });

      recordingChunks = [];
      
      // å°è¯•ä¸åŒçš„ MIME ç±»å‹
      const mimeTypes = ['audio/webm', 'audio/mp4', 'audio/wav', 'audio/ogg'];
      let selectedMimeType = 'audio/webm';
      
      for (const mimeType of mimeTypes) {
        if (MediaRecorder.isTypeSupported(mimeType)) {
          selectedMimeType = mimeType;
          break;
        }
      }

      mediaRecorder = new MediaRecorder(mediaStream, { mimeType: selectedMimeType });

      mediaRecorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) {
          recordingChunks.push(e.data);
        }
      };

      mediaRecorder.onstop = () => {
        const mimeType = mediaRecorder.mimeType || 'audio/webm';
        const blob = new Blob(recordingChunks, { type: mimeType });
        
        if (blob.size === 0) {
          alert('å½•éŸ³å¤±è´¥ï¼Œè¯·é‡è¯•');
          return;
        }

        const reader = new FileReader();
        reader.onload = () => {
          push(ref(db, `chats/${currentChatId}/messages`), {
            uid: currentUser.uid,
            username: currentUser.username,
            type: 'audio',
            data: reader.result,
            time: Date.now()
          });
        };
        reader.onerror = () => {
          alert('å½•éŸ³è½¬æ¢å¤±è´¥');
        };
        reader.readAsDataURL(blob);
      };

      mediaRecorder.onerror = (e) => {
        alert('å½•éŸ³é”™è¯¯ï¼š' + e.error);
        isRecording = false;
        recordBtn.classList.remove('recording');
        recordBtn.textContent = 'ğŸ¤';
      };

      mediaRecorder.start();
      recordBtn.classList.add('recording');
      recordBtn.textContent = 'â—';
      isRecording = true;
    } catch (err) {
      let errMsg = 'æ— æ³•è®¿é—®éº¦å…‹é£';
      if (err.name === 'NotAllowedError') {
        errMsg = 'è¯·å…è®¸è®¿é—®éº¦å…‹é£æƒé™';
      } else if (err.name === 'NotFoundError') {
        errMsg = 'æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡';
      }
      alert(errMsg + 'ï¼š' + err.message);
      isRecording = false;
    }
  });

  // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
  window.addEventListener('beforeunload', () => {
    if (mediaStream) {
      mediaStream.getTracks().forEach(t => t.stop());
    }
  });

  // åˆå§‹åŒ–è¡¨æƒ…é€‰æ‹©å™¨
  initEmojiPicker();
</script>

</body>
</html>
